{"type":"convention","content":"Overstory has zero runtime npm dependencies. Uses only Bun built-in APIs: bun:sqlite for databases, Bun.spawn for subprocesses, Bun.file for filesystem. CLI tools (bd, mulch) are invoked via Bun.spawn, not imported.","classification":"foundational","recorded_at":"2026-02-12T15:18:17.008Z","tags":["bun","dependencies","convention"],"id":"mx-ef1236"}
{"type":"convention","content":"noUncheckedIndexedAccess enabled, noExplicitAny enforced via Biome. Tab indentation, 100 char line width. Module: ESNext with bundler resolution. allowImportingTsExtensions since Bun runs TS directly (no build step).","classification":"foundational","recorded_at":"2026-02-12T15:18:20.350Z","tags":["tsconfig","biome","strict"],"id":"mx-2ce43d"}
{"type":"pattern","name":"Bun.spawn Subprocess Pattern","description":"Use Bun.spawn(cmd, { cwd, stdout: 'pipe', stderr: 'pipe' }) for subprocesses. Read output: const stdout = await new Response(proc.stdout).text(). Check exit: const exitCode = await proc.exited. All CLI wrappers (bd, mulch, tmux, git) follow this pattern.","classification":"foundational","recorded_at":"2026-02-12T15:24:33.663Z","tags":["bun","subprocess","spawn"],"id":"mx-14d62a"}
{"type":"pattern","name":"bun:sqlite Synchronous Pattern","description":"bun:sqlite is synchronous. Use Database class from 'bun:sqlite'. Enable WAL mode: db.exec('PRAGMA journal_mode=WAL'). Set busy_timeout: db.exec('PRAGMA busy_timeout=5000'). Use db.prepare() for prepared statements. db.query().all() for SELECT, db.run() for INSERT/UPDATE. No async/await needed for DB ops.","classification":"foundational","recorded_at":"2026-02-12T15:24:35.750Z","tags":["sqlite","database","sync"],"id":"mx-a64ac9"}
{"type":"convention","content":"Biome enforces: template literals over string concat, sorted imports (by path alphabetically), specific formatting for error constructor args (inline when short). Always run biome check after writing new files.","classification":"tactical","recorded_at":"2026-02-12T15:40:01.052Z","tags":["biome","formatting","lint"],"id":"mx-d00668"}
{"type":"pattern","name":"hooks-deployer test patterns","description":"hooks-deployer tests: Use Bun.file().exists() to verify file creation, JSON.parse on written content to validate structure and individual hook types by key. For write-failure error paths, use /dev/null/impossible-path as worktree path to trigger mkdir failure, then assert the thrown error is instanceof AgentError with correct agentName and code fields.","classification":"tactical","recorded_at":"2026-02-12T15:56:07.848Z","id":"mx-b90d09"}
{"type":"convention","content":"All JSON files written via Bun.write must include a trailing newline: `${JSON.stringify(data, null, '\\t')}\\n`. Biome enforces trailing newlines, and omitting them causes lint failures on generated/runtime files like sessions.json. Apply consistently across all write sites — grep for JSON.stringify to find them all.","classification":"tactical","recorded_at":"2026-02-12T16:47:21.468Z","id":"mx-24764f"}
{"type":"pattern","name":"Extract pure functions for testability","description":"Testing embedded logic in large functions: Extract pure computation into an exported function with injectable dependencies (e.g., injectable 'now' timestamp). This avoids mock.module (which leaks globally across bun test files) and enables deterministic, fast unit tests. Applied to stagger delay logic in sling.ts: extracted calculateStaggerDelay(staggerDelayMs, activeSessions, now) as a pure function.","classification":"tactical","recorded_at":"2026-02-12T16:52:50.749Z","id":"mx-35be18"}
{"type":"failure","description":"bun:test mock.module() is process-global and leaks across all test files run in the same bun test invocation. Mocking a module like ../src/config.ts in one test file causes other test files that import the same module to get the mocked version, causing 73+ test failures.","resolution":"Avoid mock.module entirely; instead extract testable pure functions or use spyOn for instance methods.","classification":"tactical","recorded_at":"2026-02-12T16:53:02.407Z","id":"mx-56558b"}
{"type":"decision","title":"Adopt 'never mock what you can use for real' testing philosophy","rationale":"mock.module() leaks across test files (mx-56558b). Real implementations catch actual parsing bugs, command construction errors, and integration issues that mocks hide. 8 of 12 test files already use real implementations successfully (temp dirs, real SQLite). Only 4 files need refactoring.","classification":"tactical","recorded_at":"2026-02-12T16:56:41.784Z","id":"mx-252b16"}
{"type":"convention","content":"Tests are colocated with source files in src/. Each test file lives alongside its source: e.g., src/config.ts has src/config.test.ts, src/mail/store.ts has src/mail/store.test.ts. The tsconfig.json include is just [\"src/**/*.ts\"]. The old __tests__/ directory pattern is deprecated.","classification":"tactical","recorded_at":"2026-02-12T17:01:03.951Z","id":"mx-c0c68d"}
{"type":"pattern","name":"macOS temp dir symlink resolution for git worktree tests","description":"macOS temp dir symlink: /var/folders -> /private/var/folders. Git resolves symlinks in worktree paths, so when creating temp git repos for tests, wrap the path with realpathSync() to avoid path comparison mismatches. This affects listWorktrees output and any path-based lookups like removeWorktree branch resolution.","classification":"tactical","recorded_at":"2026-02-12T17:05:33.398Z","id":"mx-4a865b"}
{"type":"pattern","name":"bd CLI JSON normalization","description":"bd show --json returns an array (not single object), and uses 'issue_type' field name instead of 'type'. Client must unwrap array for show() and map issue_type->type via normalizeIssue(). Integration tests exposed these mismatches that mocks hid.","classification":"tactical","recorded_at":"2026-02-12T17:08:58.843Z","id":"mx-6e9fbd"}
{"type":"pattern","name":"Bun test.skipIf needs synchronous check","description":"bun:test test.skipIf(condition) evaluates condition at test registration time (synchronously), not at runtime. Use Bun.spawnSync for CLI availability checks, not Bun.spawn in beforeAll. beforeAll runs after test registration, so async availability checks are too late for skipIf.","classification":"tactical","recorded_at":"2026-02-12T17:09:05.059Z","id":"mx-37178b"}
{"type":"pattern","name":"Selective Bun.spawn spy for testing","description":"Save original Bun.spawn before spying, define a selectiveMock function with (...args: unknown[]): unknown signature that branches on cmd[0], then cast with mockImplementation(selectiveMock as typeof Bun.spawn). This avoids TypeScript overload errors while allowing real subprocess calls to pass through.","classification":"tactical","recorded_at":"2026-02-12T17:12:42.892Z","id":"mx-2173bf"}
{"type":"pattern","name":"Delete/modify conflicts for testing tier escalation","description":"To test resolver tiers beyond auto-resolve with real git: create a delete/modify conflict (delete file on one branch, modify on other). Git reports it as unmerged but produces NO conflict markers in the working copy, causing resolveConflictsKeepIncoming to return null. This naturally escalates past Tier 2. For Tier 4 (reimagine), use a separate file in entry.filesModified that exists on both branches, since git show fails for deleted files.","classification":"tactical","recorded_at":"2026-02-12T17:12:51.278Z","id":"mx-d12879"}
{"type":"pattern","name":"Parallel agent delegation for test migration","description":"When migrating tests across an entire codebase (colocate + rewrite), delegate independent tasks to parallel agents. Order matters: do file moves first (colocate), then rewrites (which depend on new locations). Test harness should be created first since it blocks test rewrites. Real bd CLI tests revealed parsing bugs that mocks hid (issue_type vs type field, show returning array not object).","classification":"tactical","recorded_at":"2026-02-12T17:15:17.347Z","id":"mx-345bb7"}
{"type":"pattern","name":"Template clone for test repos","description":"Cache a template git repo on first call (lazy singleton), then use git clone for subsequent repos (1 subprocess instead of 5). Avoid --local flag on macOS — hardlinks trigger EFAULT in Bun rm(). Use GIT_AUTHOR/COMMITTER env vars instead of per-repo git config to eliminate 2 more subprocess spawns.","classification":"tactical","recorded_at":"2026-02-12T17:30:44.943Z","id":"mx-5ab720"}
{"type":"pattern","name":"beforeAll shared repo for CLI integration tests","description":"When tests use an external CLI (like bd) with high startup overhead (~340ms/call), share one initialized repo via beforeAll instead of beforeEach. Tests that only READ state use pre-created fixtures. Tests that MUTATE state create their own entities but skip repo recreation. Consolidate related tests to reduce CLI calls.","classification":"tactical","recorded_at":"2026-02-12T17:30:46.540Z","id":"mx-30ec57"}
{"type":"pattern","name":"Atomic file write for concurrent access","description":"For files that may be read/written concurrently by multiple processes (e.g. sessions.json), use write-to-tmp + fs.rename instead of direct Bun.write. This prevents lost-writes from interleaved read-modify-write cycles. Pattern: Bun.write(path + '.tmp', content) then rename(tmpPath, path).","classification":"tactical","recorded_at":"2026-02-12T18:15:01.626Z","id":"mx-a4d52b"}
{"type":"failure","description":"git init without -b main causes branch name mismatches between macOS (main) and Linux CI (master).","resolution":"Always pass -b main to git init in test helpers to ensure consistent branch naming across platforms.","classification":"tactical","recorded_at":"2026-02-12T20:15:14.057Z","id":"mx-e58f95"}
{"type":"pattern","name":"Dynamic git branch detection in tests","description":"When testing git operations, never hardcode branch names like 'main' or 'master'. Instead, detect the default branch dynamically using git symbolic-ref --short HEAD and pass it through as a parameter. Added getDefaultBranch() to test-helpers.ts for this purpose. Helper functions that set up git scenarios (setupCleanMerge, setupContentConflict, etc.) should accept the base branch name as a parameter rather than hardcoding it.","classification":"tactical","recorded_at":"2026-02-12T20:26:46.472Z","id":"mx-462090"}
{"type":"pattern","name":"daemon-di-testing","description":"Daemon integration testing via DI: The daemon.ts uses _tmux, _triage, _nudge DI params and exports runDaemonTick for testability. Tests use dependency injection to replace tmux (isSessionAlive/killSession), triage, and nudge with fakes. Helper functions tmuxAllAlive(), tmuxAllDead(), tmuxWithLiveness(map), triageAlways(verdict), and nudgeTracker() provide reusable test fakes. The nudgeTracker pattern returns both the mock function and a calls array for assertion. This avoids mock.module() entirely while giving full control over external dependencies.","classification":"tactical","recorded_at":"2026-02-13T15:01:00.242Z","id":"mx-415abe"}
{"type":"convention","content":"DANGEROUS_BASH_PATTERNS must cover runtime eval flags (bun -e, node -e, deno eval, python -c, perl -e, ruby -e) in addition to shell commands, since agents can use runtime eval to bypass shell pattern guards for file modification.","classification":"tactical","recorded_at":"2026-02-13T15:10:56.658Z","id":"mx-a71510"}
{"type":"convention","content":"Use canonical type imports instead of inline type assertions: when parsing JSON that should match a defined interface (like MergeEntry), import and use the actual type from types.ts rather than redefining the shape inline. This prevents field name mismatches and ensures consistency across the codebase.","classification":"tactical","recorded_at":"2026-02-13T15:24:20.712Z","id":"mx-c61667"}
{"type":"pattern","name":"makeSession-test-helper","description":"makeSession helper with Partial<T> for test fixtures: Create a helper function makeSession(overrides: Partial<SessionMetrics> = {}) that returns a complete object with sensible defaults merged with overrides. Reduces test verbosity and makes tests focus on what varies.","classification":"tactical","recorded_at":"2026-02-13T16:24:58.678Z","id":"mx-6c755f"}
{"type":"pattern","name":"real-sqlite-temp-files","description":"Real bun:sqlite in tests with temp files: Using real bun:sqlite with mkdtemp temp files in beforeEach is fast (~100ms for 31 tests) and eliminates mock complexity. Use cleanupTempDir in afterEach. Follows 'never mock what you can use for real' philosophy (mx-252b16).","classification":"tactical","recorded_at":"2026-02-13T16:24:59.906Z","id":"mx-b11f9a"}
{"type":"pattern","name":"stdout-spy-bun-test","description":"stdout spying in bun:test: Import spyOn from 'bun:test' and use spyOn(process.stdout, 'write'), not Bun.jest.spyOn (which doesn't exist). Pattern: spyOn(target, method).mockImplementation(...).","classification":"tactical","recorded_at":"2026-02-13T16:25:34.809Z","id":"mx-1b4e2e"}
{"type":"pattern","name":"supervisor-test-structure","description":"Test structure for supervisor.test.ts: Use makeSession() helper for AgentSession defaults (following nudge.test.ts pattern). Test file operations with real temp dirs (mkdtemp), test beacon generation for content/format, test command help/validation with stdout mocking. Tab indentation, colocated with source.","classification":"tactical","recorded_at":"2026-02-13T16:25:55.868Z","id":"mx-70cdbb"}
{"type":"convention","content":"merge-queue.json format: queue.ts expects direct array JSON, not {entries:[...]}. readQueue() at line 52 parses JSON.parse(trimmed) as MergeEntry[], so write JSON as [...] not {entries:[...]}.","classification":"tactical","recorded_at":"2026-02-13T16:27:07.546Z","id":"mx-42e15f"}
{"type":"pattern","name":"test-helper-idempotency","description":"When creating multiple feature branches in same test repo via beforeEach, check if base files exist before committing (await Bun.file(path).exists()) to avoid duplicate commit errors.","classification":"tactical","recorded_at":"2026-02-13T16:27:17.561Z","id":"mx-d4549e"}
{"type":"pattern","name":"worktree-test-createWorktree","description":"Use createWorktree() from worktree/manager.ts instead of manual git commands in tests. Ensures proper path normalization (macOS /var -> /private/var symlink) and consistency with production code.","classification":"tactical","recorded_at":"2026-02-13T16:32:08.124Z","id":"mx-5012f5"}
{"type":"convention","content":"Use fake tmux session names (e.g., 'overstory-agent-fake') in test fixtures to prevent real tmux calls. isSessionAlive/killSession handle non-existent sessions gracefully.","classification":"tactical","recorded_at":"2026-02-13T16:32:11.135Z","id":"mx-f1dccb"}
{"type":"pattern","name":"test-helper-makeSession","description":"Create makeSession() helper with defaults + overrides for sessions.json test fixtures, plus writeSessions() helper. Keeps tests DRY and makes path normalization explicit.","classification":"tactical","recorded_at":"2026-02-13T16:32:12.175Z","id":"mx-9d6644"}
{"type":"pattern","name":"logger-async-file-io-testing","description":"When testing logger with async writes (fire-and-forget), use Bun.sleep(50) to allow writes to complete, but don't assume write order - verify presence of events without asserting specific order.","classification":"tactical","recorded_at":"2026-02-13T16:26:04.414Z","id":"mx-8e8f83"}
