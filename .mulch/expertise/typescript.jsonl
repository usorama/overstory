{"type":"convention","content":"Overstory has zero runtime npm dependencies. Uses only Bun built-in APIs: bun:sqlite for databases, Bun.spawn for subprocesses, Bun.file for filesystem. CLI tools (bd, mulch) are invoked via Bun.spawn, not imported.","classification":"foundational","recorded_at":"2026-02-12T15:18:17.008Z","tags":["bun","dependencies","convention"],"id":"mx-ef1236"}
{"type":"convention","content":"noUncheckedIndexedAccess enabled, noExplicitAny enforced via Biome. Tab indentation, 100 char line width. Module: ESNext with bundler resolution. allowImportingTsExtensions since Bun runs TS directly (no build step).","classification":"foundational","recorded_at":"2026-02-12T15:18:20.350Z","tags":["tsconfig","biome","strict"],"id":"mx-2ce43d"}
{"type":"pattern","name":"Bun.spawn Subprocess Pattern","description":"Use Bun.spawn(cmd, { cwd, stdout: 'pipe', stderr: 'pipe' }) for subprocesses. Read output: const stdout = await new Response(proc.stdout).text(). Check exit: const exitCode = await proc.exited. All CLI wrappers (bd, mulch, tmux, git) follow this pattern.","classification":"foundational","recorded_at":"2026-02-12T15:24:33.663Z","tags":["bun","subprocess","spawn"],"id":"mx-14d62a"}
{"type":"pattern","name":"bun:sqlite Synchronous Pattern","description":"bun:sqlite is synchronous. Use Database class from 'bun:sqlite'. Enable WAL mode: db.exec('PRAGMA journal_mode=WAL'). Set busy_timeout: db.exec('PRAGMA busy_timeout=5000'). Use db.prepare() for prepared statements. db.query().all() for SELECT, db.run() for INSERT/UPDATE. No async/await needed for DB ops.","classification":"foundational","recorded_at":"2026-02-12T15:24:35.750Z","tags":["sqlite","database","sync"],"id":"mx-a64ac9"}
{"type":"convention","content":"Biome enforces: template literals over string concat, sorted imports (by path alphabetically), specific formatting for error constructor args (inline when short). Always run biome check after writing new files.","classification":"tactical","recorded_at":"2026-02-12T15:40:01.052Z","tags":["biome","formatting","lint"],"id":"mx-d00668"}
{"type":"pattern","name":"hooks-deployer test patterns","description":"hooks-deployer tests: Use Bun.file().exists() to verify file creation, JSON.parse on written content to validate structure and individual hook types by key. For write-failure error paths, use /dev/null/impossible-path as worktree path to trigger mkdir failure, then assert the thrown error is instanceof AgentError with correct agentName and code fields.","classification":"tactical","recorded_at":"2026-02-12T15:56:07.848Z","id":"mx-b90d09"}
{"type":"convention","content":"All JSON files written via Bun.write must include a trailing newline: `${JSON.stringify(data, null, '\\t')}\\n`. Biome enforces trailing newlines, and omitting them causes lint failures on generated/runtime files like sessions.json. Apply consistently across all write sites — grep for JSON.stringify to find them all.","classification":"tactical","recorded_at":"2026-02-12T16:47:21.468Z","id":"mx-24764f"}
{"type":"pattern","name":"Extract pure functions for testability","description":"Testing embedded logic in large functions: Extract pure computation into an exported function with injectable dependencies (e.g., injectable 'now' timestamp). This avoids mock.module (which leaks globally across bun test files) and enables deterministic, fast unit tests. Applied to stagger delay logic in sling.ts: extracted calculateStaggerDelay(staggerDelayMs, activeSessions, now) as a pure function.","classification":"tactical","recorded_at":"2026-02-12T16:52:50.749Z","id":"mx-35be18"}
{"type":"failure","description":"bun:test mock.module() is process-global and leaks across all test files run in the same bun test invocation. Mocking a module like ../src/config.ts in one test file causes other test files that import the same module to get the mocked version, causing 73+ test failures.","resolution":"Avoid mock.module entirely; instead extract testable pure functions or use spyOn for instance methods.","classification":"tactical","recorded_at":"2026-02-12T16:53:02.407Z","id":"mx-56558b"}
{"type":"decision","title":"Adopt 'never mock what you can use for real' testing philosophy","rationale":"mock.module() leaks across test files (mx-56558b). Real implementations catch actual parsing bugs, command construction errors, and integration issues that mocks hide. 8 of 12 test files already use real implementations successfully (temp dirs, real SQLite). Only 4 files need refactoring.","classification":"tactical","recorded_at":"2026-02-12T16:56:41.784Z","id":"mx-252b16"}
{"type":"convention","content":"Tests are colocated with source files in src/. Each test file lives alongside its source: e.g., src/config.ts has src/config.test.ts, src/mail/store.ts has src/mail/store.test.ts. The tsconfig.json include is just [\"src/**/*.ts\"]. The old __tests__/ directory pattern is deprecated.","classification":"tactical","recorded_at":"2026-02-12T17:01:03.951Z","id":"mx-c0c68d"}
{"type":"pattern","name":"macOS temp dir symlink resolution for git worktree tests","description":"macOS temp dir symlink: /var/folders -> /private/var/folders. Git resolves symlinks in worktree paths, so when creating temp git repos for tests, wrap the path with realpathSync() to avoid path comparison mismatches. This affects listWorktrees output and any path-based lookups like removeWorktree branch resolution.","classification":"tactical","recorded_at":"2026-02-12T17:05:33.398Z","id":"mx-4a865b"}
{"type":"pattern","name":"bd CLI JSON normalization","description":"bd show --json returns an array (not single object), and uses 'issue_type' field name instead of 'type'. Client must unwrap array for show() and map issue_type->type via normalizeIssue(). Integration tests exposed these mismatches that mocks hid.","classification":"tactical","recorded_at":"2026-02-12T17:08:58.843Z","id":"mx-6e9fbd"}
{"type":"pattern","name":"Bun test.skipIf needs synchronous check","description":"bun:test test.skipIf(condition) evaluates condition at test registration time (synchronously), not at runtime. Use Bun.spawnSync for CLI availability checks, not Bun.spawn in beforeAll. beforeAll runs after test registration, so async availability checks are too late for skipIf.","classification":"tactical","recorded_at":"2026-02-12T17:09:05.059Z","id":"mx-37178b"}
{"type":"pattern","name":"Selective Bun.spawn spy for testing","description":"Save original Bun.spawn before spying, define a selectiveMock function with (...args: unknown[]): unknown signature that branches on cmd[0], then cast with mockImplementation(selectiveMock as typeof Bun.spawn). This avoids TypeScript overload errors while allowing real subprocess calls to pass through.","classification":"tactical","recorded_at":"2026-02-12T17:12:42.892Z","id":"mx-2173bf"}
{"type":"pattern","name":"Delete/modify conflicts for testing tier escalation","description":"To test resolver tiers beyond auto-resolve with real git: create a delete/modify conflict (delete file on one branch, modify on other). Git reports it as unmerged but produces NO conflict markers in the working copy, causing resolveConflictsKeepIncoming to return null. This naturally escalates past Tier 2. For Tier 4 (reimagine), use a separate file in entry.filesModified that exists on both branches, since git show fails for deleted files.","classification":"tactical","recorded_at":"2026-02-12T17:12:51.278Z","id":"mx-d12879"}
{"type":"pattern","name":"Parallel agent delegation for test migration","description":"When migrating tests across an entire codebase (colocate + rewrite), delegate independent tasks to parallel agents. Order matters: do file moves first (colocate), then rewrites (which depend on new locations). Test harness should be created first since it blocks test rewrites. Real bd CLI tests revealed parsing bugs that mocks hid (issue_type vs type field, show returning array not object).","classification":"tactical","recorded_at":"2026-02-12T17:15:17.347Z","id":"mx-345bb7"}
{"type":"pattern","name":"Template clone for test repos","description":"Cache a template git repo on first call (lazy singleton), then use git clone for subsequent repos (1 subprocess instead of 5). Avoid --local flag on macOS — hardlinks trigger EFAULT in Bun rm(). Use GIT_AUTHOR/COMMITTER env vars instead of per-repo git config to eliminate 2 more subprocess spawns.","classification":"tactical","recorded_at":"2026-02-12T17:30:44.943Z","id":"mx-5ab720"}
{"type":"pattern","name":"beforeAll shared repo for CLI integration tests","description":"When tests use an external CLI (like bd) with high startup overhead (~340ms/call), share one initialized repo via beforeAll instead of beforeEach. Tests that only READ state use pre-created fixtures. Tests that MUTATE state create their own entities but skip repo recreation. Consolidate related tests to reduce CLI calls.","classification":"tactical","recorded_at":"2026-02-12T17:30:46.540Z","id":"mx-30ec57"}
{"type":"pattern","name":"Atomic file write for concurrent access","description":"For files that may be read/written concurrently by multiple processes (e.g. sessions.json), use write-to-tmp + fs.rename instead of direct Bun.write. This prevents lost-writes from interleaved read-modify-write cycles. Pattern: Bun.write(path + '.tmp', content) then rename(tmpPath, path).","classification":"tactical","recorded_at":"2026-02-12T18:15:01.626Z","id":"mx-a4d52b"}
{"type":"failure","description":"git init without -b main causes branch name mismatches between macOS (main) and Linux CI (master).","resolution":"Always pass -b main to git init in test helpers to ensure consistent branch naming across platforms.","classification":"tactical","recorded_at":"2026-02-12T20:15:14.057Z","id":"mx-e58f95"}
{"type":"pattern","name":"Dynamic git branch detection in tests","description":"When testing git operations, never hardcode branch names like 'main' or 'master'. Instead, detect the default branch dynamically using git symbolic-ref --short HEAD and pass it through as a parameter. Added getDefaultBranch() to test-helpers.ts for this purpose. Helper functions that set up git scenarios (setupCleanMerge, setupContentConflict, etc.) should accept the base branch name as a parameter rather than hardcoding it.","classification":"tactical","recorded_at":"2026-02-12T20:26:46.472Z","id":"mx-462090"}
{"type":"pattern","name":"daemon-di-testing","description":"Daemon integration testing via DI: The daemon.ts uses _tmux, _triage, _nudge DI params and exports runDaemonTick for testability. Tests use dependency injection to replace tmux (isSessionAlive/killSession), triage, and nudge with fakes. Helper functions tmuxAllAlive(), tmuxAllDead(), tmuxWithLiveness(map), triageAlways(verdict), and nudgeTracker() provide reusable test fakes. The nudgeTracker pattern returns both the mock function and a calls array for assertion. This avoids mock.module() entirely while giving full control over external dependencies.","classification":"tactical","recorded_at":"2026-02-13T15:01:00.242Z","id":"mx-415abe"}
{"type":"convention","content":"DANGEROUS_BASH_PATTERNS must cover runtime eval flags (bun -e, node -e, deno eval, python -c, perl -e, ruby -e) in addition to shell commands, since agents can use runtime eval to bypass shell pattern guards for file modification.","classification":"tactical","recorded_at":"2026-02-13T15:10:56.658Z","id":"mx-a71510"}
{"type":"convention","content":"Use canonical type imports instead of inline type assertions: when parsing JSON that should match a defined interface (like MergeEntry), import and use the actual type from types.ts rather than redefining the shape inline. This prevents field name mismatches and ensures consistency across the codebase.","classification":"tactical","recorded_at":"2026-02-13T15:24:20.712Z","id":"mx-c61667"}
{"type":"pattern","name":"makeSession-test-helper","description":"makeSession helper with Partial<T> for test fixtures: Create a helper function makeSession(overrides: Partial<SessionMetrics> = {}) that returns a complete object with sensible defaults merged with overrides. Reduces test verbosity and makes tests focus on what varies.","classification":"tactical","recorded_at":"2026-02-13T16:24:58.678Z","id":"mx-6c755f"}
{"type":"pattern","name":"real-sqlite-temp-files","description":"Real bun:sqlite in tests with temp files: Using real bun:sqlite with mkdtemp temp files in beforeEach is fast (~100ms for 31 tests) and eliminates mock complexity. Use cleanupTempDir in afterEach. Follows 'never mock what you can use for real' philosophy (mx-252b16).","classification":"tactical","recorded_at":"2026-02-13T16:24:59.906Z","id":"mx-b11f9a"}
{"type":"pattern","name":"stdout-spy-bun-test","description":"stdout spying in bun:test: Import spyOn from 'bun:test' and use spyOn(process.stdout, 'write'), not Bun.jest.spyOn (which doesn't exist). Pattern: spyOn(target, method).mockImplementation(...).","classification":"tactical","recorded_at":"2026-02-13T16:25:34.809Z","id":"mx-1b4e2e"}
{"type":"pattern","name":"supervisor-test-structure","description":"Test structure for supervisor.test.ts: Use makeSession() helper for AgentSession defaults (following nudge.test.ts pattern). Test file operations with real temp dirs (mkdtemp), test beacon generation for content/format, test command help/validation with stdout mocking. Tab indentation, colocated with source.","classification":"tactical","recorded_at":"2026-02-13T16:25:55.868Z","id":"mx-70cdbb"}
{"type":"convention","content":"merge-queue.json format: queue.ts expects direct array JSON, not {entries:[...]}. readQueue() at line 52 parses JSON.parse(trimmed) as MergeEntry[], so write JSON as [...] not {entries:[...]}.","classification":"tactical","recorded_at":"2026-02-13T16:27:07.546Z","id":"mx-42e15f"}
{"type":"pattern","name":"test-helper-idempotency","description":"When creating multiple feature branches in same test repo via beforeEach, check if base files exist before committing (await Bun.file(path).exists()) to avoid duplicate commit errors.","classification":"tactical","recorded_at":"2026-02-13T16:27:17.561Z","id":"mx-d4549e"}
{"type":"pattern","name":"worktree-test-createWorktree","description":"Use createWorktree() from worktree/manager.ts instead of manual git commands in tests. Ensures proper path normalization (macOS /var -> /private/var symlink) and consistency with production code.","classification":"tactical","recorded_at":"2026-02-13T16:32:08.124Z","id":"mx-5012f5"}
{"type":"convention","content":"Use fake tmux session names (e.g., 'overstory-agent-fake') in test fixtures to prevent real tmux calls. isSessionAlive/killSession handle non-existent sessions gracefully.","classification":"tactical","recorded_at":"2026-02-13T16:32:11.135Z","id":"mx-f1dccb"}
{"type":"pattern","name":"test-helper-makeSession","description":"Create makeSession() helper with defaults + overrides for sessions.json test fixtures, plus writeSessions() helper. Keeps tests DRY and makes path normalization explicit.","classification":"tactical","recorded_at":"2026-02-13T16:32:12.175Z","id":"mx-9d6644"}
{"type":"pattern","name":"logger-async-file-io-testing","description":"When testing logger with async writes (fire-and-forget), use Bun.sleep(50) to allow writes to complete, but don't assume write order - verify presence of events without asserting specific order.","classification":"tactical","recorded_at":"2026-02-13T16:26:04.414Z","id":"mx-8e8f83"}
{"type":"pattern","name":"mock-aspirational-cli","description":"When testing modules that wrap CLI tools with non-existent APIs, use unit tests with mocked subprocess calls. Document the API mismatch in a JSDoc comment explaining why mocking is used and when the tests can be converted to integration tests.","classification":"tactical","recorded_at":"2026-02-13T16:28:35.144Z","id":"mx-4fec3d"}
{"type":"pattern","name":"bun-test-mock-cleanup-afterEach","description":"Mock cleanup with afterEach: When mocking global objects like Bun.spawn in bun:test, use afterEach (not just beforeEach) to restore the original. Place afterEach at the same scope level as the beforeEach that saves the original, ensuring cleanup happens after the last test in the suite to prevent mock leaks across test files.","classification":"tactical","recorded_at":"2026-02-13T16:41:57.062Z","id":"mx-42bf5c"}
{"type":"pattern","name":"test-infinite-loop-isolation","description":"When testing commands that start infinite loops (like dashboard polling), use process.chdir to a temp dir WITHOUT required config files so initialization throws BEFORE the loop starts. This proves validation passed while preventing background loops from leaking across test files. Promise.race abandons promises but doesn't stop running code.","classification":"tactical","recorded_at":"2026-02-13T16:53:43.914Z","id":"mx-9d7dba"}
{"type":"failure","description":"bun:test runs all files in a single process — global state mutations (like overriding Bun.spawn in mocks) leak across test files. molecules.test.ts Bun.spawn leak caused 103 cascading failures.","resolution":"When mocking globals, ALWAYS restore in afterEach at the describe level, not just beforeEach. Add afterEach(() => { Bun.spawn = originalSpawn; }) at the top-level describe scope.","classification":"tactical","recorded_at":"2026-02-13T16:55:33.014Z","id":"mx-f8f088"}
{"type":"failure","description":"Dashboard tests starting infinite poll loops via Promise.race leak loops after test completes. Abandoned promise's loop continues writing to stdout, polluting subsequent test files.","resolution":"chdir to a temp dir without .overstory/config.yaml so loadConfig() throws before entering the while loop. Prevents infinite loop from ever starting.","classification":"tactical","recorded_at":"2026-02-13T16:55:34.758Z","id":"mx-3ba5b0"}
{"type":"pattern","name":"subprocess-timeout-for-tests","description":"Subprocess timeout for external CLI calls in tests: When spawning external binaries (like claude) via Bun.spawn that may exist on the system and hang in test environments, add a configurable timeoutMs parameter with setTimeout+proc.kill() to enforce a deadline. Tests pass a short timeout (e.g. 500ms) to fail fast, while production uses a sensible default (e.g. 30s). The timeout timer is cleared in a finally block to avoid leaks.","classification":"tactical","recorded_at":"2026-02-13T17:18:22.804Z","id":"mx-651754"}
{"type":"pattern","name":"coordinator-di-testing","description":"Coordinator command DI testing pattern: coordinator.ts exports CoordinatorDeps interface with optional _tmux field (same pattern as daemon.ts _tmux/_triage/_nudge). coordinatorCommand() accepts deps as second param, defaults to real implementations. Tests build fake tmux via makeFakeTmux() helper with configurable sessionAliveMap and call tracking. Eliminates mock.module() entirely, preventing the process-global mock leak (mx-56558b).","classification":"tactical","recorded_at":"2026-02-13T17:23:40.187Z","id":"mx-42cecf"}
{"type":"pattern","name":"transcript-token-extraction","description":"Claude Code transcript JSONL files at ~/.claude/projects/{project-slug}/{session-id}.jsonl contain per-turn token usage. Parse 'assistant' type entries, extract message.usage (input_tokens, output_tokens, cache_read_input_tokens, cache_creation_input_tokens) and message.model. Hooks (PostToolUse, Stop) do NOT include token data in stdin.","classification":"tactical","recorded_at":"2026-02-13T17:39:08.916Z","id":"mx-90f116"}
{"type":"pattern","name":"ci-git-identity-config","description":"CI test repos need repo-level git config (user.name/email) because resolver's runGit doesn't pass GIT_TEST_ENV and CI runners lack global git identity. Fix: set config in createTempGitRepo().","classification":"tactical","recorded_at":"2026-02-13T18:40:48.816Z","id":"mx-a61ea1"}
{"type":"pattern","name":"bun-spy-mock-clear","description":"bun v1.3.9+ test reporter may flush output through console.log/error between spy creation and test action, inflating call counts. Always call mockClear() after spyOn() before the assertion-triggering action.","classification":"tactical","recorded_at":"2026-02-13T18:40:53.673Z","id":"mx-a30b79"}
{"type":"pattern","name":"tool-arg-filter-dispatch-table","description":"Tool argument filter pattern: use a Record<string, ToolFilter> dispatch table mapping tool names to per-tool filter functions. Each filter uses pickDefined() to whitelist fields and typeof checks for safe summary generation. Unknown tools get empty args + tool name as summary. This keeps filtering logic declarative and easy to extend for new tools.","classification":"tactical","recorded_at":"2026-02-13T22:17:08.259Z","id":"mx-8481ba"}
{"type":"pattern","name":"SQLite RETURNING with null guard","description":"EventStore SQLite pattern: use RETURNING clause with bun:sqlite prepare<ReturnType>() to get auto-generated IDs from INSERT statements. Handle the nullable return with an explicit null check instead of non-null assertion (!) to satisfy Biome noNonNullAssertion rule.","classification":"tactical","recorded_at":"2026-02-13T22:18:39.712Z","id":"mx-f886f4"}
{"type":"pattern","name":"Dynamic SQL filter builder for EventQueryOptions","description":"For SQLite stores with optional query filters (since/until/level/limit), use a shared buildFilterClauses() helper that builds WHERE conditions and params from an options object. Combine with pre-existing conditions (e.g., agent_name filter) by accepting initial conditions/params arrays. Avoids duplicating filter logic across getByAgent/getByRun/getErrors/getTimeline.","classification":"tactical","recorded_at":"2026-02-13T22:18:45.751Z","id":"mx-c5b31a"}
{"type":"pattern","name":"sqlite-session-store-migration","description":"SessionStore migration: when adding a new field to an interface (AgentSession.runId), all files creating object literals of that type must be updated. Use 'tsc --noEmit' to find every site. For compat shims reading old JSON data, normalize missing fields with ?? null defaults. SQLite ON CONFLICT(agent_name) DO UPDATE provides clean upsert semantics.","classification":"tactical","recorded_at":"2026-02-13T22:24:30.131Z","id":"mx-319ff3"}
{"type":"pattern","name":"bash-pretooluse-guard-layering","description":"Bash PreToolUse guard layering: non-implementation agents get blanket file-modification blocks (buildBashFileGuardScript), while implementation agents (builder/merger) get path-boundary validation (buildBashPathBoundaryScript) that extracts absolute paths from commands and checks them against OVERSTORY_WORKTREE_PATH. Guard composition in deployHooks uses spread order [...pathGuards, ...dangerGuards, ...capabilityGuards] to control evaluation priority.","classification":"tactical","recorded_at":"2026-02-13T22:30:24.091Z","id":"mx-f134c4"}
{"type":"pattern","name":"stdin-pipe-testing","description":"Hook stdin integration: when testing CLI commands that read from Bun.stdin.stream(), use Bun.spawn subprocess with stdin pipe rather than mocking, consistent with the never-mock-what-you-can-use-for-real philosophy. Write a small .ts helper script to the temp dir, spawn it with bun run, pipe JSON to stdin, then verify results via real SQLite reads.","classification":"tactical","recorded_at":"2026-02-13T22:32:42.893Z","id":"mx-055cf7"}
{"type":"failure","description":"'Never mock what you can use for real' has a critical exception: tests calling killAllTmuxSessions() or other global-state-mutating functions MUST mock those operations. Real tmux kills during bun test destroyed a live agent swarm.","resolution":"The philosophy applies to isolated resources (temp dirs, :memory: DBs) but NOT to shared global resources (tmux server, process table). Add tmux mocking to clean.test.ts.","classification":"tactical","recorded_at":"2026-02-14T04:14:07.638Z","id":"mx-7aee0a"}
{"type":"pattern","name":"mock-helper-factory","description":"Mock helper factory for complex interfaces: Create a factory function that returns a mock implementation with all required methods, accepting optional overrides for specific methods. Useful for testing code that depends on large interfaces (e.g., MulchClient with 10+ methods) without duplicating mock setup across tests. Example: createMockMulchClient(recordImpl?) returns full MulchClient with minimal stubs, allowing tests to override only the record method.","classification":"tactical","recorded_at":"2026-02-14T06:30:41.279Z","id":"mx-cbd948"}
{"type":"pattern","name":"pathExists helper","description":"Use stat() from node:fs/promises for both files and directories. Bun.file().exists() only works for files, not directories. Pattern: async function pathExists(path: string): Promise<boolean> { try { await stat(path); return true; } catch { return false; } }","classification":"tactical","recorded_at":"2026-02-15T20:54:54.676Z","id":"mx-194ff2"}
{"type":"convention","content":"Test fixtures for OverstoryConfig must include all required fields: project, agents (with maxDepth), worktrees, beads, mulch, merge, watchdog, sandbox, logging. Common mistake: forgetting beads/mulch/merge/logging when creating minimal test config.","classification":"tactical","recorded_at":"2026-02-15T20:55:00.812Z","id":"mx-e05513"}
{"type":"pattern","name":"PRAGMA queries without parameters","description":"PRAGMA queries don't support parameter placeholders: Use PRAGMA table_info(${tableName}) with .all() not .all(tableName). Template literals in SQL string, not bind parameters.","classification":"tactical","recorded_at":"2026-02-15T20:48:23.384Z","id":"mx-0ceb6e"}
{"type":"pattern","name":"SQLite readonly mode with fresh databases","description":"Opening a SQLite database in readonly mode can fail if the database is fresh or doesn't have data yet. For health checks, open without readonly: new Database(path) instead of new Database(path, { readonly: true }).","classification":"tactical","recorded_at":"2026-02-15T20:48:27.797Z","id":"mx-01873e"}
{"type":"pattern","name":"Path normalization for symlinks","description":"When comparing file paths from different sources (git worktree list, SessionStore, file system), use realpathSync() to normalize symlinks before comparison. On macOS, /tmp -> /private/tmp causes mismatches without normalization. Wrap in try/catch since realpathSync throws for non-existent paths.","classification":"tactical","recorded_at":"2026-02-15T20:49:35.187Z","id":"mx-79fa68"}
{"type":"convention","content":"Test git repo setup: Always disable GPG signing in test git repos with 'git config commit.gpgsign false' to prevent test failures from GPG configuration.","classification":"tactical","recorded_at":"2026-02-15T20:49:35.753Z","id":"mx-913aa9"}
{"type":"convention","content":"Mail test pattern for repeated checks: When testing mail check multiple times, must send new messages between checks since check/checkInject mark messages as read. Use separate client.send() calls to create fresh unread messages for each test assertion.","classification":"tactical","recorded_at":"2026-02-15T20:43:46.704Z","id":"mx-9f4650"}
{"type":"pattern","name":"Dependency Injection for Test Isolation","description":"Instead of mock.module() (which leaks across tests), define optional deps parameter on functions and pass mock implementations. Example: checkConsistency(config, dir, deps?) where deps = {listSessions, isProcessAlive}. Tests create mocks and pass via deps param. This prevents module-level mock leakage.","classification":"tactical","recorded_at":"2026-02-15T22:20:35.829Z","id":"mx-2412b2"}
{"type":"pattern","name":"sqlite-corrupted-db-error-handling","description":"SQLite error handling in tests: Corrupted database files may not fail at Database constructor but at first prepare() call. Wrap prepare() in try-catch to handle corrupted db scenarios.","classification":"tactical","recorded_at":"2026-02-16T15:23:56.971Z","id":"mx-454a78"}
{"type":"convention","content":"Avoid variable shadowing when importing objects with common names like 'color'. If a local variable would shadow an import, rename the local (e.g., 'color' -> 'stateColor', 'levelColor'). TypeScript will flag property access on the wrong type.","classification":"tactical","recorded_at":"2026-02-16T15:50:26.408Z","id":"mx-e6850b"}
{"type":"pattern","name":"subprocess-env-test","description":"Use Bun.spawn subprocess pattern to test environment-dependent behavior at import time (e.g., NO_COLOR, FORCE_COLOR). Execute code with 'bun -e' and custom env vars, capture stdout, parse JSON result. Allows testing static initialization logic.","classification":"tactical","recorded_at":"2026-02-16T15:50:38.185Z","id":"mx-5a43e2"}
{"type":"convention","content":"Biome formatter removes trailing zeros from numeric literals: use 0.3 instead of 0.30 in test fixtures and code to avoid formatting errors","classification":"tactical","recorded_at":"2026-02-16T21:35:12.519Z","id":"mx-77c733"}
{"type":"convention","content":"DI test helpers (like makeDeps in coordinator.test.ts) must always inject ALL fake dependencies, not just some. Optional injection leads to production fallback code executing in tests, which fails in CI where external CLIs (overstory, mulch, bd) are not in PATH.","classification":"tactical","recorded_at":"2026-02-16T22:56:08.331Z","tags":["testing","di","ci"],"id":"mx-82fc11"}
{"type":"pattern","name":"DI testing for testability","description":"Extract testable functions that accept dependencies as parameters (e.g., autoRecordExpertise takes MulchClient) rather than directly importing singletons. This enables fake implementations for testing without mocking modules. See src/commands/log.ts autoRecordExpertise and createFakeMulchClient in tests.","classification":"tactical","recorded_at":"2026-02-17T01:35:43.108Z","id":"mx-fae8b9"}
{"type":"pattern","name":"workflow-classification","description":"Session insight analysis: classify workflow by tool percentages (read-heavy >50% Read/Grep/Glob, write-heavy >50% Edit/Write, bash-heavy >50% Bash, balanced otherwise)","classification":"tactical","recorded_at":"2026-02-17T01:59:33.514Z","evidence":{"bead":"overstory-ep5m"},"tags":["auto-insight","session-analysis"],"id":"mx-523fc1"}
{"type":"convention","content":"Hot file detection threshold: files edited 3+ times in a session indicate high iteration/complexity. Limit to top 3 hot files to avoid noise in mulch records.","classification":"tactical","recorded_at":"2026-02-17T01:59:39.662Z","evidence":{"bead":"overstory-ep5m"},"tags":["auto-insight","hot-files"],"id":"mx-dc2d08"}
{"type":"failure","description":"agents.test.ts had process.chdir(tempDir) in beforeEach but never restored originalCwd in afterEach, leaving the Bun test process with a deleted temp dir as cwd. This poisoned subsequent test files in the same worker — 6 tests in prime.test.ts and color.test.ts failed only in CI due to test file ordering.","resolution":"Always save and restore originalCwd when using process.chdir in tests. Subprocess tests using cwd: process.cwd() with relative imports are fragile — use absolute paths derived from import.meta.dir instead. These bugs are invisible locally since they depend on Bun test file ordering.","classification":"tactical","recorded_at":"2026-02-17T03:08:40.580Z","tags":["process.chdir","test-isolation","ci-only-failure","bun-test"],"id":"mx-f4756f"}
{"type":"convention","content":"Extracting pure functions from I/O-heavy code improves testability — pass minimal interfaces (ReadonlyArray<{parentAgent, capability}>) instead of full objects.","classification":"tactical","recorded_at":"2026-02-17T15:51:03.358Z","evidence":{"bead":"overstory-smkc"},"id":"mx-e488b2"}
{"type":"convention","content":"Test pattern for capturing stderr: use origStderrWrite to save original, wrap process.stderr.write to capture stderrOutput string, restore in afterEach. Matches stdout capture pattern already used. Useful for validating warning/error output that shouldn't corrupt JSON output.","classification":"tactical","recorded_at":"2026-02-17T16:05:51.338Z","evidence":{"bead":"overstory-0l52"},"id":"mx-d6fc31"}
{"type":"convention","content":"When adding a required field to OverstoryConfig, ALL test fixtures across the codebase (src/agents/manifest.test.ts, src/doctor/*.test.ts) must be updated to include the new field — this is a cross-cutting concern that affects files outside any single builder's scope. Consider making new OverstoryConfig fields optional or assigning fixture updates to a separate task when doing batch coordination.","classification":"tactical","recorded_at":"2026-02-19T20:32:39.688Z","evidence":{"bead":"overstory-ip89"},"id":"mx-9e8470"}
{"type":"convention","content":"ModelRef = ModelAlias | (string & {}) pattern: the (string & {}) union preserves IDE autocomplete for known aliases but TypeScript resolves the full union to string, breaking assignment to narrower types. Any code assigning config.models[role] (ModelRef) to a local ModelName type will fail typecheck and needs an 'as ModelName' cast or type guard.","classification":"tactical","recorded_at":"2026-02-19T20:32:45.997Z","evidence":{"bead":"overstory-ip89"},"id":"mx-892112"}
{"type":"convention","content":"When a parallel builder adds a required field to OverstoryConfig (like providers), the fixture-fixer builder must: (1) replicate the types.ts/config.ts changes, (2) add providers to every OverstoryConfig object literal in test files after the merge section and before watchdog, (3) update resolveModel to use string instead of a local ModelName type alias.","classification":"tactical","recorded_at":"2026-02-19T20:41:58.543Z","evidence":{"bead":"overstory-e3kd"},"id":"mx-aa5b74"}
{"type":"convention","content":"When validating TypeScript typed config at runtime, cast to 'unknown' first to guard against YAML parse issues (e.g. 'const p = provider as unknown; if (typeof p \\!== \"object\")') — this satisfies noExplicitAny while still doing a runtime type guard","classification":"tactical","recorded_at":"2026-02-20T15:31:14.320Z","evidence":{"commit":"36d3fe7"},"id":"mx-a05fb7"}
{"type":"convention","content":"resolveProviderEnv() accepts an explicit env parameter (Record<string, string | undefined>) defaulting to process.env — this makes the function fully unit-testable without touching actual env vars","classification":"tactical","recorded_at":"2026-02-20T15:42:49.381Z","evidence":{"bead":"overstory-2hk3"},"id":"mx-164703"}
{"type":"convention","content":"MulchClient search() options pattern: optional second arg { file?: string; sortByScore?: boolean } translates to --file and --sort-by-score CLI flags. Record outcome fields (outcomeStatus, outcomeDuration, outcomeTestResults, outcomeAgent) map to --outcome-* flags. outcomeDuration uses !== undefined guard to allow zero value.","classification":"tactical","recorded_at":"2026-02-20T21:19:12.561Z","id":"mx-8a86f0"}
{"type":"convention","content":"In multi-builder scenarios where a test file depends on a template/config file being modified by a sibling builder, cherry-pick the sibling's committed change to unblock quality gates. Note this in the completion mail so the orchestrator knows both branches touch the same file (clean duplicate change).","classification":"tactical","recorded_at":"2026-02-20T21:27:38.590Z","evidence":{"bead":"overstory-lqis"},"id":"mx-0f1089"}
