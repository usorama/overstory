{"type":"pattern","name":"CLI Command Structure","description":"All commands live in src/commands/{name}.ts. Each exports an async function matching the command name. CLI router in src/index.ts dispatches based on argv. Commands use Bun.spawn for subprocess calls. All state in .overstory/ directory.","classification":"foundational","recorded_at":"2026-02-12T15:18:26.091Z","tags":["commands","cli","structure"],"id":"mx-97add4"}
{"type":"pattern","name":"CLI command pattern with flag parsing","description":"All commands export an async function taking args: string[]. Use getFlag(args, '--name') for valued flags and hasFlag(args, '--json') for booleans. Use process.stdout.write (not console.log) for output. Wrap in try/finally to close DB stores. Use ValidationError for bad input, domain-specific errors (AgentError, MailError, MergeError) for operation failures.","classification":"tactical","recorded_at":"2026-02-12T15:40:08.301Z","tags":["cli","commands","patterns"],"id":"mx-4cd4ed"}
{"type":"failure","description":"Claude Code hooks require ALL hook types (SessionStart, Stop, PreCompact) to use {matcher, hooks} wrapper format. Flat [{type, command}] arrays cause validation error, blocking agent startup.","resolution":"Fixed template and init fallback to wrap all hook types in {matcher: '', hooks: [...]} format. Also: must run 'bun link' so overstory CLI is in PATH for tmux-spawned agents.","classification":"tactical","recorded_at":"2026-02-12T16:07:30.473Z","id":"mx-5771cb"}
{"type":"pattern","name":"Integration testing workflow for CLI","description":"Install via 'bun link', test CLI commands systematically (help, flags, edge cases, error handling), use beads to track bugs found. Key areas to test: flag validation, error messages, state management (sessions.json), cross-component interactions (sling->worktree->tmux->hooks), and cleanup.","classification":"tactical","recorded_at":"2026-02-12T16:24:18.520Z","id":"mx-9c57b2"}
{"type":"failure","description":"tmux list-sessions #{pid} returns the tmux server PID, shared across all sessions (e.g. 55777 for everything).","resolution":"Use tmux list-panes -t <session> -F '#{pane_pid}' to get the actual process PID running inside a specific pane.","classification":"tactical","recorded_at":"2026-02-12T16:29:38.254Z","id":"mx-17ef66"}
{"type":"pattern","name":"Help flag pattern for CLI commands","description":"Add a const HELP string above the export function, then check args.includes('--help') || args.includes('-h') as the first thing in the command function and return early after printing. Consistent across all 10 subcommands.","classification":"tactical","recorded_at":"2026-02-12T16:32:44.003Z","id":"mx-d1f655"}
{"type":"convention","content":"Version lives in two places: package.json (version field) and src/index.ts (const VERSION). Use 'bun run version:bump <major|minor|patch>' to update both atomically. GitHub Actions auto-tag workflow verifies they match before creating a tag.","classification":"tactical","recorded_at":"2026-02-12T16:33:49.171Z","id":"mx-48f4ae"}
{"type":"convention","content":"biome check runs in CI on all files including .overstory/ JSON configs. These files must use tab indentation and compact array formatting to pass. Run 'biome check --write' on generated config files before committing.","classification":"tactical","recorded_at":"2026-02-12T16:39:59.746Z","id":"mx-902c66"}
{"type":"convention","content":"Validate external references (branches, file paths) early in CLI commands before passing them to subsystem functions. Use git rev-parse --verify refs/heads/<branch> for branch existence checks and Bun.file().exists() for file path checks. Throw ValidationError with field and value context for user-friendly messages instead of letting raw subprocess errors propagate.","classification":"tactical","recorded_at":"2026-02-12T16:43:27.724Z","id":"mx-8fa3eb"}
{"type":"pattern","name":"capabilityIndex must be populated at generation time","description":"When init.ts generates agent-manifest.json, it must build capabilityIndex from agent definitions — not leave it empty. The manifest loader rebuilds it at load time, but the persisted file should be correct for external tools or humans reading it. Build the index inline using the same loop pattern as manifest.ts buildCapabilityIndex.","classification":"tactical","recorded_at":"2026-02-12T16:47:31.208Z","id":"mx-05e7ca"}
{"type":"pattern","name":"Init must generate its own hooks.json, not read agent template","description":"The hooks.json.tmpl template contains {{AGENT_NAME}} placeholders for per-agent deployment. The init command should generate orchestrator hooks.json independently with tab indentation matching Biome config.","classification":"tactical","recorded_at":"2026-02-12T17:51:21.532Z","evidence":{"issue":"overstory-lmo"},"id":"mx-daeb1e"}
{"type":"convention","content":"After beads.show(), sling checks that status is 'open' or 'in_progress'. Closed/resolved issues are rejected with ValidationError to prevent wasted agent spawns on completed work.","classification":"tactical","recorded_at":"2026-02-12T17:51:22.902Z","evidence":{"issue":"overstory-cz8"},"id":"mx-909892"}
{"type":"pattern","name":"JSON output exclusivity","description":"JSON output flag pattern: use if/else with args.includes('--json') — JSON branch outputs only JSON, else branch outputs only human-readable. Check args parameter (not process.argv) for consistency with how other flags are parsed in the same command function. See status.ts as the canonical example.","classification":"tactical","recorded_at":"2026-02-12T17:56:03.045Z","id":"mx-09fa87"}
{"type":"pattern","name":"watch --background daemonization","description":"watch --background: use Bun.spawn detached to daemonize, write PID to .overstory/watchdog.pid, check for existing PID before spawning. Foreground mode also writes PID file and cleans it up on SIGINT. Child process is spawned with stdio ignore and unref() so parent can exit.","classification":"tactical","recorded_at":"2026-02-12T17:57:06.266Z","id":"mx-9db97d"}
{"type":"pattern","name":"Comprehensive CLI testing checklist","description":"Test each command with (1) --help flag, (2) no args, (3) valid args, (4) --json flag, (5) invalid/missing required args, (6) edge case values (empty strings, NaN, negative numbers), (7) nonexistent references (IDs, agents, branches), (8) duplicate operations (already-read, already-running), (9) outside project directory, (10) combined flags. This systematic approach found 10 bugs across overstory commands.","classification":"tactical","recorded_at":"2026-02-12T18:11:14.631Z","id":"mx-dbacb9"}
{"type":"failure","description":"init --force strips {{AGENT_NAME}} from hooks.json template producing broken log commands that fail with VALIDATION_ERROR","resolution":"Init must generate orchestrator hooks with explicit '--agent orchestrator' instead of stripping the placeholder to empty string. See overstory-ne0.","classification":"tactical","recorded_at":"2026-02-12T18:11:24.559Z","id":"mx-74f9ae"}
{"type":"pattern","name":"CLI numeric flag validation","description":"All numeric CLI flags (--depth, --interval) must check Number.isNaN() and enforce minimum bounds. Use ValidationError with field + value context. Pattern: parse with Number.parseInt, then guard with Number.isNaN(val) || val < MIN.","classification":"tactical","recorded_at":"2026-02-12T18:14:12.417Z","id":"mx-0cc7f8"}
{"type":"pattern","name":"Non-fatal CLI error exit code","description":"When a CLI command detects a non-fatal but user-facing error condition (e.g. 'already running'), write to stderr and set process.exitCode = 1 rather than throwing. This gives a clear message without a stack trace while signaling failure to callers.","classification":"tactical","recorded_at":"2026-02-12T18:15:02.652Z","id":"mx-654452"}
{"type":"pattern","name":"Idempotent operation feedback","description":"When a CLI command performs an idempotent operation (e.g. markRead on already-read message), return status info ({ alreadyRead: boolean }) from the client layer and print an informational message in the CLI layer rather than silently succeeding or throwing.","classification":"tactical","recorded_at":"2026-02-12T18:15:04.063Z","id":"mx-662333"}
{"type":"pattern","name":"Empty string validation after CLI flag parsing","description":"getFlag() returns raw string values that pass truthy checks even when empty. Always trim and check .length > 0 for string flags, and filter empty strings from comma-split arrays (e.g., '--files \"\"' splits to [''] not []).","classification":"tactical","recorded_at":"2026-02-12T18:15:41.521Z","id":"mx-041a57"}
{"type":"pattern","name":"User-friendly error interception at CLI entry point","description":"Catch specific error subclasses (e.g., WorktreeError) in the main catch handler in index.ts and check error message contents to replace raw tool output with user-friendly messages. Put specific checks before the generic OverstoryError handler.","classification":"tactical","recorded_at":"2026-02-12T18:15:47.051Z","id":"mx-0c30bb"}
{"type":"pattern","name":"E2E testing workflow","description":"E2E testing pattern for overstory: (1) init, (2) sling agents with various flags, (3) test mail round-trip between agents, (4) simulate commits on agent branches, (5) test merge with dry-run then actual, (6) test conflict resolution tiers, (7) test worktree clean, (8) verify status/metrics throughout. Critical: always reset test commits with git reset --hard before finishing to avoid polluting main.","classification":"tactical","recorded_at":"2026-02-12T18:35:53.692Z","id":"mx-48788d"}
{"type":"failure","description":"AI-resolve tier (tier 3) can corrupt files: claude --print with conflict resolution prompt returns conversational prose instead of code. The resolved content is written to the file without validation, then committed.","resolution":"Need output validation: (1) check output parses as the target language, (2) check it doesn't start with conversational phrases, (3) fall back to tier 4 if validation fails. Filed as overstory-39u P1.","classification":"tactical","recorded_at":"2026-02-12T18:35:59.830Z","id":"mx-bc02ec"}
{"type":"pattern","name":"agent-state-ripple","description":"When adding a new AgentState, ripple the change through all state filters: types.ts (type union), worktree clean (cleanup eligibility), sling (concurrency/uniqueness checks), watchdog daemon (skip terminal states), and status (reconciliation). Missing any of these creates subtle bugs where agents get stuck or miscounted.","classification":"tactical","recorded_at":"2026-02-12T18:41:50.365Z","id":"mx-26c2c6"}
{"type":"failure","description":"sling depth check used >= instead of > for maxDepth comparison, preventing agents from spawning at the deepest allowed depth","resolution":"Changed depth >= maxDepth to depth > maxDepth in sling.ts. The hierarchy is orchestrator(0)->lead(1)->specialist(2), so depth=maxDepth is the allowed leaf.","classification":"tactical","recorded_at":"2026-02-12T18:41:54.039Z","id":"mx-7a623e"}
{"type":"pattern","name":"worktree-absolute-paths","description":"Paths written into agent overlay CLAUDE.md must be absolute, not relative. Worktrees are separate git checkouts that don't have .overstory/ (it's gitignored), so relative paths to .overstory/specs/ or other non-tracked dirs won't resolve. Always use resolve() from node:path before embedding paths in overlays.","classification":"tactical","recorded_at":"2026-02-12T18:41:57.722Z","id":"mx-643490"}
{"type":"pattern","name":"mail-subcommand-addition","description":"When adding new mail subcommands: add store-level method to MailStore interface and implementation in store.ts, add handler function in commands/mail.ts, wire into switch statement, update help text, and update error message listing valid subcommands.","classification":"tactical","recorded_at":"2026-02-12T18:42:04.016Z","id":"mx-034178"}
{"type":"decision","title":"Record session metrics in session-end log handler","rationale":"Centralizes metrics recording in the session-end event handler in log.ts rather than requiring explicit calls. Computes durationMs from session startedAt to current time. Non-fatal try/catch wrapping ensures metrics failures never break session-end handling.","classification":"tactical","recorded_at":"2026-02-12T18:42:15.280Z","id":"mx-7a0ed0"}
{"type":"pattern","name":"merge-checkout-skip","description":"Merge resolver must check current branch before git checkout to avoid 'already checked out' error when git worktrees exist. Use git symbolic-ref --short HEAD to detect current branch, skip checkout if already on canonical.","classification":"tactical","recorded_at":"2026-02-12T18:43:20.332Z","id":"mx-19449e"}
{"type":"pattern","name":"ai-resolve-prose-guard","description":"LLM-based conflict resolution (claude --print) can output conversational prose instead of code. Validate output with looksLikeProse() before writing to file — check for common LLM preambles (I, Here, Let me), markdown fencing, and permission requests. Fall through to next tier on detection.","classification":"tactical","recorded_at":"2026-02-12T18:43:23.671Z","id":"mx-174fa5"}
{"type":"pattern","name":"headless-agent-mode","description":"Sling must use 'claude -p <prompt>' instead of interactive mode + sendKeys. Interactive mode gets stuck at welcome screen. -p runs the full task and exits cleanly. State transitions from hooks don't fire in -p mode, so initial state should be 'working' not 'booting'.","classification":"tactical","recorded_at":"2026-02-12T18:57:31.795Z","id":"mx-52b5e8"}
{"type":"pattern","name":"e2e-lifecycle-validation","description":"E2E lifecycle validation sequence: (1) bd create issue (2) write spec to .overstory/specs/ (3) sling agent with --spec and --files (4) monitor via status/mail (5) merge --branch (6) worktree clean --completed (7) bd close. This exercises the full orchestrator workflow.","classification":"tactical","recorded_at":"2026-02-12T18:57:32.621Z","id":"mx-c4c785"}
{"type":"failure","description":"mail.ts used raw process.cwd() to locate .overstory/mail.db while all other commands used loadConfig for project root resolution. When agents ran mail commands from worktrees, they opened a separate DB at the wrong location.","resolution":"Exported resolveProjectRoot from config.ts. Updated mailCommand to resolve the project root before opening the DB. Now mail.ts matches the pattern of all other commands.","classification":"tactical","recorded_at":"2026-02-12T19:53:12.704Z","id":"mx-6d6161"}
{"type":"failure","description":"resolveProjectRoot() short-circuits in worktrees because .overstory/config.yaml is a tracked file that exists in every worktree. Mail DB ends up siloed per worktree.","resolution":"Fix: either always use git worktree resolution (skip the existsSync shortcut), or detect worktree paths by checking if cwd contains .overstory/worktrees/. Beads (bd) works correctly by following .git -> gitdir.","classification":"tactical","recorded_at":"2026-02-12T20:11:46.632Z","id":"mx-1ca5bd"}
{"type":"pattern","name":"e2e-sling-lifecycle-v2","description":"E2E sling lifecycle validation: (1) bd create (2) write spec (3) sling agent (4) verify overlay (5) status --verbose (6) check tmux (7) wait for completion (8) merge --dry-run then merge (9) quality gates (10) worktree clean. Also verify: mail round-trip (currently broken by mail silo), metrics (broken by headless hooks).","classification":"tactical","recorded_at":"2026-02-12T20:11:55.384Z","id":"mx-111cec"}
{"type":"convention","content":"biome.json must ignore .overstory/ directory since it contains runtime state files (mail.db, metrics.db, merge-queue.json, sessions.json, logs) that should not be linted.","classification":"tactical","recorded_at":"2026-02-12T20:15:46.541Z","id":"mx-6b75ca"}
{"type":"pattern","name":"positional-arg-flag-skip","description":"CLI positional arg extraction must skip flag values: after each --flag, the next arg is its value and should not be treated as a positional argument. Filter out flag-value pairs before extracting positional args.","classification":"tactical","recorded_at":"2026-02-12T20:16:40.503Z","id":"mx-aef71b"}
{"type":"pattern","name":"nudge-mechanism","description":"overstory nudge <agent> [msg] sends text via tmux sendKeys. Retry (3x, 500ms), debounce (500ms via nudge-state.json), session validation. Auto-nudge in mail send for urgent/high. Core nudgeAgent() exported for reuse.","classification":"tactical","recorded_at":"2026-02-12T20:31:48.352Z","id":"mx-ce8373"}
{"type":"pattern","name":"E2E lifecycle validation sequence","description":"E2E lifecycle validation sequence for overstory: (1) overstory init (2) bd create task (3) write spec to .overstory/specs/ (4) overstory sling with --capability --name (5) monitor via overstory status (6) validate mail round-trip (7) overstory merge --branch (8) verify result on canonical branch. Each step can surface integration bugs not caught by unit tests.","classification":"tactical","recorded_at":"2026-02-12T20:58:12.778Z","id":"mx-3857ab"}
{"type":"pattern","name":"e2e-sling-lifecycle-validated","description":"E2E sling lifecycle validated: init -> bd create -> write spec -> sling agent -> agent boots in tmux -> reads overlay CLAUDE.md -> runs mulch prime -> checks mail -> reads spec -> implements -> quality gates (bun test, bun run lint, bun run typecheck) -> git commit -> bd close -> mail send to orchestrator. Two bugs found: (1) sendKeys multiline beacon not auto-submitted (P1 overstory-y2ob), (2) biome/tsc not on PATH in worktrees (P2 overstory-ff2s).","classification":"tactical","recorded_at":"2026-02-12T21:12:23.703Z","id":"mx-58f680"}
{"type":"pattern","name":"agent-def-deployment-in-init","description":"Agent def deployment in init: init.ts copies agents/*.md from overstory install dir (resolved via import.meta.dir) to .overstory/agent-defs/ in target project. Uses readdir + Bun.file/Bun.write. On --force, overwrites existing defs.","classification":"tactical","recorded_at":"2026-02-12T21:26:38.012Z","id":"mx-f39d81"}
{"type":"pattern","name":"e2e-init-sling-lifecycle","description":"E2E init-sling lifecycle test: creates temp git repo, runs initCommand, verifies all artifacts (.overstory/config.yaml, agent-manifest.json, hooks.json, agent-defs/*.md, .gitignore, subdirs), loads config + manifest via real APIs, generates overlay. Proves project-agnostic init works.","classification":"tactical","recorded_at":"2026-02-12T21:30:14.766Z","id":"mx-d6d046"}
{"type":"pattern","name":"dogfood-lifecycle-v1","description":"Dogfood lifecycle validated: bd create -> write spec -> overstory sling -> agent boots in tmux (interactive mode, sendKeys beacon) -> agent reads spec, writes code, runs quality gates, commits, closes issue, sends mail -> orchestrator receives mail, verifies, merges (clean-merge tier), runs tests on main, cleans worktree. Full E2E in ~7 minutes. Key finding: agent may need manual Enter keypress after beacon send to trigger processing - the 2s sleep in sling.ts may not be enough for TUI initialization.","classification":"tactical","recorded_at":"2026-02-12T21:49:16.696Z","id":"mx-bc0bcf"}
