{"type":"pattern","name":"Agent Lifecycle: Sling-Execute-Close","description":"Agent spawn: overstory sling creates worktree + overlay CLAUDE.md + hooks + tmux session. Agent reads base def + overlay, executes task. Agent reports completion via bd close. Worktree cleaned after merge. Branch naming: overstory/{agentName}/{beadId}.","classification":"foundational","recorded_at":"2026-02-12T15:18:28.885Z","tags":["lifecycle","sling","worktree"],"id":"mx-389460"}
{"type":"pattern","name":"State reconciliation in status display","description":"When displaying agent status, reconcile recorded state with actual tmux session existence. If tmux session is dead but agent state is booting/working, mark as zombie and persist the correction to sessions.json. This prevents stale states from misleading the orchestrator.","classification":"tactical","recorded_at":"2026-02-12T16:32:50.002Z","id":"mx-1c2df8"}
{"type":"pattern","name":"PATH injection for tmux-spawned agents","description":"When creating tmux sessions for agents, detect the overstory binary directory via 'which overstory' (or fallback to process.argv[0] dirname) and prepend it to PATH in the tmux command wrapper. This ensures hooks inside agent sessions can find the overstory CLI.","classification":"tactical","recorded_at":"2026-02-12T16:32:55.639Z","id":"mx-2e4365"}
{"type":"pattern","name":"Session lastActivity update in hooks","description":"log.ts tool-start and tool-end events update the agent lastActivity timestamp in sessions.json. session-end calls updateIdentity to increment sessionsCompleted and record completed task. All updates are non-fatal to avoid breaking hook execution.","classification":"tactical","recorded_at":"2026-02-12T16:33:32.203Z","id":"mx-6f17c5"}
{"type":"pattern","name":"Worktree cleanup: separate force flags and zombie pruning","description":"Worktree cleanup lifecycle: separate force flags for worktree removal (handles untracked files) and branch deletion (handles unmerged branches) via forceBranch option. Agent branches are typically unmerged when cleaned, so cleanup should always force-delete branches. Session pruning uses worktree path existence as the source of truth for whether a zombie entry is stale.","classification":"tactical","recorded_at":"2026-02-12T16:44:56.427Z","id":"mx-03059d"}
{"type":"pattern","name":"Env var injection via tmux createSession","description":"createSession() in worktree/tmux.ts accepts an optional env Record<string, string> parameter. Env vars are exported as shell statements prepended to the wrapped command. Used to set OVERSTORY_AGENT_NAME so agent definitions can reference it. All agent base .md files expect this var — always pass it from sling.","classification":"tactical","recorded_at":"2026-02-12T16:47:24.935Z","id":"mx-191c37"}
{"type":"pattern","name":"Force-remove agent worktrees on cleanup","description":"Agent worktrees always contain untracked .claude/ files (overlay CLAUDE.md + settings.local.json) deployed by sling. Non-forced git worktree remove fails on these. Always use force:true in removeWorktree for agent cleanup.","classification":"tactical","recorded_at":"2026-02-12T17:51:20.723Z","evidence":{"issue":"overstory-bhz"},"id":"mx-618c1b"}
{"type":"pattern","name":"Agent state transition via log events","description":"Log events (tool-start, tool-end) should transition agent state from booting to working. Without this, agents permanently stuck at booting unless watchdog runs. updateLastActivity in log.ts must also set state='working' when state='booting'.","classification":"tactical","recorded_at":"2026-02-12T17:52:34.144Z","evidence":{"issue":"overstory-51t"},"id":"mx-7478dc"}
{"type":"pattern","name":"Initial task prompt via tmux send-keys","description":"After sling creates a tmux session running Claude Code, it must send an initial prompt via sendKeys() to tell the agent to read its assignment and begin working. Without this, the agent sits idle at the REPL.","classification":"tactical","recorded_at":"2026-02-12T17:52:37.125Z","evidence":{"issue":"overstory-lx9"},"id":"mx-c58de8"}
{"type":"pattern","name":"read-only-overlay-gating","description":"overlay.ts uses a READ_ONLY_CAPABILITIES set (scout, reviewer) to conditionally render quality gates and constraints sections. Read-only agents get a lightweight Completion section instead of full quality gates. The capability field was added to OverlayConfig. Template uses {{QUALITY_GATES}} and {{CONSTRAINTS}} placeholders.","classification":"tactical","recorded_at":"2026-02-12T19:47:40.508Z","id":"mx-f8bf2d"}
{"type":"decision","title":"Headless mode initial state is working not booting","rationale":"Since agents are spawned in headless mode (claude -p) where hooks do not fire, the booting->working transition in log.ts never occurs. sling.ts now sets initial state to working at spawn time. The booting state is only meaningful for interactive mode.","classification":"tactical","recorded_at":"2026-02-12T19:47:46.123Z","id":"mx-e0f870"}
{"type":"failure","description":"Headless mode (claude -p) disables all Claude Code hooks, breaking: mail check injection, log events, session metrics, and lastActivity updates.","resolution":"Options: (1) switch from claude -p to interactive mode with sendKeys, (2) build hook-free alternatives (e.g., periodic mail polling in prompt, metrics recorded by sling/watchdog instead of hooks), (3) use claude --hooks flag if available.","classification":"tactical","recorded_at":"2026-02-12T20:11:49.450Z","id":"mx-7fd64a"}
{"type":"failure","description":"Sling must pass --model from agent manifest to claude CLI. Without it, all agents use default model, defeating cost optimization (scouts=haiku) and capability matching (leads=opus).","resolution":"Added --model ${agentDef.model} flag to the claude command string in sling.ts line 312, reading the model from the loaded agent manifest entry.","classification":"tactical","recorded_at":"2026-02-12T20:15:46.380Z","id":"mx-aa807d"}
{"type":"convention","content":"Agent definition files should include four behavioral sections after the core content (Constraints, Communication Protocol): (1) Propulsion Principle - execute immediately without asking for confirmation, (2) Failure Modes - named anti-patterns specific to the role (e.g., FILE_SCOPE_VIOLATION for builder, READ_ONLY_VIOLATION for scout/reviewer, UNNECESSARY_SPAWN for lead, TIER_SKIP for merger) plus universal ones (SILENT_FAILURE, INCOMPLETE_CLOSE), (3) Cost Awareness - brief reminder that tokens cost money, (4) Completion Protocol - explicit numbered steps for how to finish work. These go before the final Overlay section.","classification":"tactical","recorded_at":"2026-02-12T20:25:47.732Z","id":"mx-331d21"}
{"type":"decision","title":"Interactive mode over headless for agent spawning","rationale":"Headless mode (claude -p) prevented hooks from firing, breaking mail injection, metrics, logs, and lastActivity. Interactive mode with sendKeys beacon enables full hook lifecycle.","classification":"tactical","recorded_at":"2026-02-12T20:31:42.493Z","id":"mx-1749f9"}
{"type":"pattern","name":"capability-specific-hooks","description":"hooks-deployer accepts capability param, merges PreToolUse guards per role. Scout/reviewer get Write/Edit/NotebookEdit blocks. Guards prepended before base logging hook. Guard format: echo JSON with decision:block.","classification":"tactical","recorded_at":"2026-02-12T20:31:49.117Z","id":"mx-51aced"}
{"type":"pattern","name":"structured-startup-beacon","description":"Structured agent startup beacon: buildBeacon() in sling.ts produces a multi-line beacon with [OVERSTORY] header (name, capability, ISO timestamp, task ID), hierarchy context (depth + parent), and numbered startup protocol (read overlay, mulch prime, mail check, begin work). Exported as pure function for testability. Sent via tmux sendKeys as the agent first user message.","classification":"tactical","recorded_at":"2026-02-12T20:32:27.834Z","id":"mx-53f0e8"}
{"type":"pattern","name":"pretooluse-bash-danger-guards","description":"PreToolUse Bash danger guards: getDangerGuards(agentName) returns HookEntry[] with a single Bash matcher that reads stdin JSON, extracts the command field via sed, then checks three patterns: (1) git push to main/master — block, (2) git reset --hard — block, (3) git checkout -b with wrong branch naming — block. Guard script is embedded as a shell one-liner in the hook command string. Applied to ALL capabilities in deployHooks() by prepending before capability-specific guards.","classification":"tactical","recorded_at":"2026-02-12T20:34:32.313Z","id":"mx-d74481"}
{"type":"failure","description":"Beacon sendKeys multiline bug: tmux send-keys with multiline text inserts newlines into Claude Code TUI input buffer but does not auto-submit.","resolution":"Filed as overstory-y2ob (P1). Workaround: send separate Enter via tmux send-keys after the beacon. Proper fix: flatten beacon to single line or add explicit Enter delay in sendKeys.","classification":"tactical","recorded_at":"2026-02-12T21:12:30.173Z","id":"mx-f8edbf"}
{"type":"pattern","name":"e2e-lifecycle-validated","description":"E2E lifecycle validation sequence for overstory: (1) bd create trivial task (2) write spec to .overstory/specs/ (3) sling builder agent with --spec and --files (4) verify tmux alive + overlay written + sessions.json updated (5) observe agent reads overlay, loads mulch, checks mail, implements, runs quality gates, commits, closes bead, sends result mail. Two known issues: beacon sendKeys may not trigger immediate work (nudge needed), worktree lacks node_modules (agent must use bun run lint not biome check).","classification":"tactical","recorded_at":"2026-02-12T21:12:58.705Z","id":"mx-a5b1d7"}
{"type":"failure","description":"Beacon prompt via tmux sendKeys does not reliably trigger agent to start working. After sling sends the beacon, Claude Code TUI shows the text but does not generate a response.","resolution":"Workaround: send overstory nudge --force immediately after sling. Long-term fix: increase sleep before sendKeys, or add auto-nudge to sling post-beacon.","classification":"tactical","recorded_at":"2026-02-12T21:13:05.529Z","id":"mx-c96569"}
{"type":"failure","description":"Multiline text via tmux send-keys breaks Claude Code TUI submission. Newlines cause embedded Enter keystrokes preventing final Enter from triggering submission.","resolution":"Flatten all sendKeys text to single line (replace newlines with spaces). Beacon must be single-line. See overstory-y2ob, overstory-cczf.","classification":"tactical","recorded_at":"2026-02-12T21:17:25.768Z","id":"mx-3a65f5"}
{"type":"failure","description":"Agent worktrees lack node_modules; quality gate commands must use bun run variants (bun run lint, bun run typecheck) not direct biome/tsc calls","resolution":"Updated all agent definitions and overlay.ts formatQualityGates() to use bun run lint and bun run typecheck. The bun run variants resolve commands through package.json scripts, which finds the binaries via bun module resolution even without node_modules in the worktree.","classification":"tactical","recorded_at":"2026-02-12T21:20:18.642Z","id":"mx-744929"}
{"type":"failure","description":"Beacon sendKeys Enter not reliably triggering Claude Code TUI submission (overstory-yhv6). Root cause: 2s sleep before sendKeys was insufficient for Claude Code TUI initialization — text arrived but Enter was consumed during TUI setup.","resolution":"Increased initial sleep from 2s to 3s AND added follow-up sendKeys('') after 500ms delay to send redundant Enter. The redundant Enter either submits the beacon if first Enter was consumed, or harmlessly presses Enter on empty input.","classification":"tactical","recorded_at":"2026-02-12T21:56:48.636Z","id":"mx-5a19c9"}
{"type":"pattern","name":"structural-tool-enforcement","description":"NON_IMPLEMENTATION_CAPABILITIES set (scout, reviewer, lead) gates both tool-level (Write/Edit/NotebookEdit block) and bash-level (file-modifying command blocklist with safe-prefix whitelist) guards via getCapabilityGuards(). Only builder and merger are implementation capabilities. Bash file guards use whitelist-first approach: safe prefixes (overstory, bd, git status/log/diff, mulch, bun test/lint/typecheck) exit 0 early, then dangerous patterns (sed -i, echo >, tee, vim, mv, cp, rm, mkdir, touch, git add/commit/push, bun install) are blocked.","classification":"tactical","recorded_at":"2026-02-12T22:00:08.180Z","id":"mx-54aa52"}
{"type":"pattern","name":"session-lifecycle-checkpoint-handoff","description":"session-lifecycle: checkpoint.json saves agent progress to {agentsDir}/{name}/checkpoint.json, handoffs.json tracks session transitions as an append-only array, prime --compact restores from checkpoint with Session Recovery section. Uses LifecycleError, follows identity.ts patterns (mkdir + Bun.write + Bun.file).","classification":"tactical","recorded_at":"2026-02-12T22:08:54.526Z","id":"mx-848c30"}
{"type":"pattern","name":"session-lifecycle","description":"checkpoint.json in agents/{name}/ saves agent progress before compaction/handoff. handoffs.json tracks session transitions. prime --compact auto-restores from checkpoint. Three-layer model: Identity (permanent) / Sandbox (worktree) / Session (ephemeral).","classification":"tactical","recorded_at":"2026-02-12T22:11:57.148Z","id":"mx-52130d"}
{"type":"pattern","name":"coordinator-agent","description":"New 'coordinator' capability type — persistent orchestrator that runs at project root (no worktree), cannot modify code (structurally enforced via NON_IMPLEMENTATION_CAPABILITIES), dispatches agents via sling, tracks batches via task groups, receives escalations via typed mail. Spawned by 'overstory coordinator start', not 'overstory sling'. Uses opus model. Session recorded in sessions.json with beadId='' and worktreePath=projectRoot.","classification":"tactical","recorded_at":"2026-02-12T22:28:57.907Z","id":"mx-85f352"}
{"type":"pattern","name":"supervisor-agent-definition","description":"Supervisor capability (depth 1) bridges coordinator and leaf workers. Persistent per-project team lead assigned to bead task. Manages worker lifecycle (worker_done->verify->merge_ready->merged), nudge protocol (3 attempts, 15min), escalation (warning/error/critical). Read-only enforcement via NON_IMPLEMENTATION_CAPABILITIES (needs update in hooks-deployer.ts). Follows coordinator.md structure: Role, Capabilities, Workflow, Worker Lifecycle Management, Nudge Protocol, Escalation, Constraints, Failure Modes, Persistence, Propulsion, Overlay.","classification":"tactical","recorded_at":"2026-02-12T22:46:22.839Z","id":"mx-ed4a8a"}
{"type":"convention","content":"Agent definition files follow standardized structure: (1) Title/intro, (2) Role, (3) Capabilities (tools/spawning/communication/expertise), (4) Workflow (numbered steps), (5) Specialized sections (per role), (6) Constraints, (7) Failure Modes, (8) Cost Awareness (optional), (9) Completion Protocol, (10) Persistence and Context Recovery (for persistent agents), (11) Propulsion Principle, (12) Overlay. See coordinator.md and supervisor.md for reference.","classification":"tactical","recorded_at":"2026-02-12T22:46:24.286Z","id":"mx-a50565"}
{"type":"pattern","name":"supervisor-agent","description":"New 'supervisor' capability type — persistent per-project team lead (depth 1) that bridges coordinator and leaf workers. Runs at project root (no worktree), read-only enforcement via NON_IMPLEMENTATION_CAPABILITIES. CLI: overstory supervisor start/stop/status. Requires --task (bead assignment) and --name. Spawns workers at depth 2, handles worker_done->merge_ready lifecycle, nudge protocol (3 attempts, 15min), escalation to coordinator.","classification":"tactical","recorded_at":"2026-02-12T22:55:40.836Z","id":"mx-5331b4"}
{"type":"convention","content":"Scout agents have a narrow write exception: overstory spec write is allowed because it only writes to .overstory/specs/ (not source code). This preserves the read-only invariant while letting scouts produce actionable work packages. The constraint section must explicitly call out this exception. Scouts must always create a beads issue (bd create) before writing a spec -- SPEC_WITHOUT_ISSUE is a named failure mode.","classification":"tactical","recorded_at":"2026-02-13T14:26:48.246Z","id":"mx-794405"}
{"type":"convention","content":"Coordinator delegates spec writing to scouts for exploration-heavy tasks via overstory spec write; retains direct spec writing for well-understood scopes","classification":"tactical","recorded_at":"2026-02-13T14:34:07.885Z","id":"mx-7a79a1"}
{"type":"pattern","name":"auto-propulsion-protocol","description":"Phase 3 self-propulsion for workers — builders send worker_done mail after quality gates, prime injects activation context for robustness, group auto-close sends coordinator mail notification","classification":"tactical","recorded_at":"2026-02-13T14:36:10.122Z","id":"mx-f1fbaa"}
{"type":"pattern","name":"auto-propulsion-v1","description":"Phase 3 self-propulsion pattern — builders send worker_done mail after quality gates (overlay.ts injects step), prime.ts injects activation context for bound tasks, group.ts sends coordinator mail on auto-close. Key design: activation context is a safety net (agents get task info via beacon + overlay + prime), worker_done is the structured completion signal supervisors need.","classification":"tactical","recorded_at":"2026-02-13T14:37:24.906Z","id":"mx-ad6552"}
{"type":"pattern","name":"session-record-before-beacon","description":"Session recording must precede beacon send: sessions.json entry must be written before tmux send-keys beacon, so that hook-triggered updateLastActivity() can find the session and transition booting->working. Race condition caused coordinator stuck in booting (overstory-036f). Applied to both coordinator.ts and sling.ts.","classification":"tactical","recorded_at":"2026-02-13T14:45:35.418Z","id":"mx-fac18b"}
{"type":"failure","description":"Status display active filter only excluded zombie state, not completed — completed coordinator sessions appeared as active agents. Zombie reconciliation also missed stalled state — externally-killed tmux sessions with stalled state were not detected.","resolution":"Fixed printStatus to filter both zombie and completed (overstory-7sma). Added stalled to zombie reconciliation check in gatherStatus (overstory-jtxw).","classification":"tactical","recorded_at":"2026-02-13T14:45:41.670Z","id":"mx-d8e924"}
{"type":"decision","title":"native-team-tool-blocking","rationale":"All overstory agents get Claude Code native team/task tools (Task, TeamCreate, SendMessage, etc.) blocked via PreToolUse hooks. Enforces delegation through overstory sling rather than bypassing the orchestration system. Applied to all capabilities. (overstory-x6xm)","classification":"tactical","recorded_at":"2026-02-13T14:47:26.953Z","id":"mx-ce7db6"}
{"type":"convention","content":"Coordinator and supervisor capabilities get git add/commit whitelisted in the bash file guard via COORDINATION_SAFE_PREFIXES. Allows beads sync, mulch records, and test fix commits while git push remains blocked. buildBashFileGuardScript accepts extraSafePrefixes param. (overstory-4cto)","classification":"tactical","recorded_at":"2026-02-13T14:47:28.439Z","id":"mx-9cf8fb"}
{"type":"pattern","name":"progressive-nudging-escalation","description":"Progressive nudging pattern: instead of binary stalled->terminate, use escalationLevel (0-3) with stalledSince timestamp to advance through warn->nudge->escalate->terminate stages. Time between stages controlled by nudgeIntervalMs config. Level calculation: Math.min(Math.floor(elapsedMs/nudgeIntervalMs), maxLevel). Each stage has a distinct executeEscalationAction handler. Reset escalation on agent recovery (action=none + stalledSince != null) or termination.","classification":"tactical","recorded_at":"2026-02-13T15:01:28.800Z","id":"mx-cc8540"}
{"type":"pattern","name":"monitor-agent","description":"New 'monitor' capability type — persistent Tier 2 continuous patrol agent. Runs at project root (no worktree, like coordinator). Read-only with git add/commit whitelisted for beads/mulch sync. Registered in NON_IMPLEMENTATION + COORDINATION sets in hooks-deployer.ts.","classification":"tactical","recorded_at":"2026-02-13T15:04:04.423Z","id":"mx-f4554f"}
{"type":"pattern","name":"progressive-nudge-protocol","description":"Daemon uses escalationLevel (0-3) and stalledSince on AgentSession for graduated response: 0=warn, 1=nudge, 2=escalate (triage if enabled), 3=terminate. Level increments each tick while stalled, resets on activity. Configurable via nudgeIntervalMs.","classification":"tactical","recorded_at":"2026-02-13T15:04:06.101Z","id":"mx-2a3a6f"}
{"type":"pattern","name":"env-guard-hook-isolation","description":"ENV_GUARD prefix pattern: All hook commands generated by hooks-deployer.ts start with [ -z \"$OVERSTORY_AGENT_NAME\" ] && exit 0; so hooks deployed to project root only activate for agent sessions (which have the env var set via tmux), not the user's own Claude Code session.","classification":"tactical","recorded_at":"2026-02-13T15:10:55.344Z","id":"mx-9753ce"}
{"type":"pattern","name":"coordinator-mail-spec-delivery","description":"Coordinator spec delivery via mail: Since coordinator cannot write files (enforced by hooks), task specs are delivered to builders via overstory mail send with --type dispatch --priority high. The builder reads its mail on startup and gets full implementation instructions. No spec file needed.","classification":"tactical","recorded_at":"2026-02-13T15:26:51.377Z","id":"mx-724e86"}
{"type":"decision","title":"Hierarchy enforcement via validateHierarchy in sling.ts","rationale":"Coordinator was short-circuiting hierarchy by directly spawning builders. Code enforcement in sling.ts (HierarchyError when parentAgent is null and capability != lead) prevents this. --force-hierarchy flag available for debugging.","classification":"tactical","recorded_at":"2026-02-13T15:50:13.666Z","id":"mx-c9698d"}
{"type":"pattern","name":"lead-three-phase-workflow","description":"Lead three-phase workflow: Scout→Build→Verify. Phase 1: spawn scout to explore, wait for result mail. Phase 2: write specs from findings, spawn builders with file scope. Phase 3: monitor, optionally review, signal merge_ready to coordinator. Leads own spec production — coordinator never writes specs.","classification":"tactical","recorded_at":"2026-02-13T15:50:19.732Z","id":"mx-7801cd"}
{"type":"pattern","name":"at-scale-swarm-coordination","description":"First at-scale swarm coordination (4 leads, 20+ builders): Leads cannot write code (hooks block Edit/Write, must spawn builders). Individual test files passing does NOT guarantee full suite passes — always run full bun test as final gate. overstory merge with conflicting branches requires spawning a builder to manually resolve.","classification":"tactical","recorded_at":"2026-02-13T16:55:40.671Z","id":"mx-e730b2"}
{"type":"pattern","name":"base-def-injection","description":"Base agent definition injection: overlay.ts reads baseDefinition from OverlayConfig and injects it via {{BASE_DEFINITION}} placeholder before task-specific Layer 2 content. sling.ts reads the .md file from agent-defs dir and passes content through.","classification":"tactical","recorded_at":"2026-02-13T18:35:52.240Z","id":"mx-cdb8b9"}
{"type":"decision","title":"Base def injection for non-sling agents","rationale":"coordinator, supervisor, monitor agents had no access to their role definitions at spawn time","classification":"tactical","recorded_at":"2026-02-13T20:41:45.612Z","id":"mx-f0fb99"}
{"type":"decision","title":"Guard writeOverlay against canonical project root","rationale":"During e2e runs, a subagent's overlay was written to the orchestrator's .claude/CLAUDE.md instead of the worktree's copy. Added isCanonicalRoot check in writeOverlay that throws AgentError if worktreePath contains .overstory/config.yaml, preventing overwrites of the user's root .claude/ directory (overstory-uwg4).","classification":"tactical","recorded_at":"2026-02-13T22:32:02.546Z","id":"mx-a5ab3a"}
{"type":"decision","title":"Orchestrator tmux registration for reverse-nudge","rationale":"Mail is pull-only (UserPromptSubmit hook). Without reverse-nudge, orchestrator sits idle until user types. Registration file lets agents wake orchestrator via tmux send-keys.","classification":"tactical","recorded_at":"2026-02-13T22:38:23.902Z","id":"mx-d99d9c"}
{"type":"pattern","name":"synthetic-session-end-on-clean","description":"Before killAllTmuxSessions() in clean.ts, iterate active sessions from SessionStore and write session_end events to EventStore with reason='clean'. This ensures observability records are complete even when Stop hook can't fire due to external process kill.","classification":"tactical","recorded_at":"2026-02-14T02:54:21.131Z","id":"mx-c7f622"}
{"type":"pattern","name":"coordinator-hooks-deployment","description":"Coordinator start deploys hooks to project root via deployHooks(projectRoot, 'coordinator', 'coordinator'). The ENV_GUARD prefix ensures hooks only activate for the coordinator's tmux session (where OVERSTORY_AGENT_NAME is set), not for the user's own Claude Code. This gives the coordinator event logging, mail check --inject, and activity tracking.","classification":"tactical","recorded_at":"2026-02-14T02:54:28.266Z","id":"mx-9dc32e"}
{"type":"failure","description":"clean.test.ts uses real killAllTmuxSessions() with no mocks. During dogfooding, bun test kills all live overstory-prefixed tmux sessions — the root cause of the coordinator crash.","resolution":"Mock tmux in clean.test.ts or use fake session name prefix (mx-f1dccb). Tests that assume 'no tmux server running' become destructive when run inside a live swarm.","classification":"tactical","recorded_at":"2026-02-14T04:14:06.048Z","id":"mx-f468c3"}
{"type":"pattern","name":"lead-auto-nudge-coordinator","description":"Lead session-end triggers coordinator auto-nudge: when transitionToCompleted fires for a lead agent, a pending-nudge marker is written to .overstory/pending-nudges/coordinator.json so the coordinator wakes up to process merge_ready messages","classification":"tactical","recorded_at":"2026-02-14T04:20:20.687Z","id":"mx-44a777"}
{"type":"decision","title":"persistent-agent-session-end-skip","rationale":"Added PERSISTENT_CAPABILITIES set in log.ts transitionToCompleted() to skip the transition for these capabilities, only updating lastActivity instead.","classification":"tactical","recorded_at":"2026-02-14T04:23:31.781Z","id":"mx-2ef75a"}
{"type":"pattern","name":"Builder scope creep causes merge failures","description":"Builders sometimes create out-of-scope commits (e.g. adding community files, modifying package.json) alongside their implementation commit. When this happens, overstory merge fails due to .beads/issues.jsonl conflicts. Prevention: builder specs should explicitly state no out-of-scope changes. Recovery: use cherry-pick leads to extract clean commits.","classification":"tactical","recorded_at":"2026-02-14T06:41:34.186Z","tags":["builder","scope-creep","prevention"],"id":"mx-68f258"}
{"type":"convention","content":"Watchdog auxiliary operations use fire-and-forget pattern: recordFailure() and recordEvent() wrap try/catch to swallow errors, ensuring mulch/EventStore failures never crash daemon. Core responsibility (health monitoring, state transitions) must never block on instrumentation.","classification":"tactical","recorded_at":"2026-02-15T20:36:57.518Z","tags":["watchdog","resilience"],"id":"mx-4ebdf5"}
{"type":"convention","content":"PostToolUse hook can contain multiple commands: templates/hooks.json.tmpl shows PostToolUse hook array can have multiple hook objects, each with type and command. First hook logs tool-end, second hook checks mail with debounce.","classification":"tactical","recorded_at":"2026-02-15T20:43:40.957Z","id":"mx-112cf4"}
{"type":"pattern","name":"orchestrator-mail-alias-mismatch","description":"Leads send mail to 'orchestrator' by default, not 'coordinator'. The coordinator agent name and the default recipient alias are mismatched. Use 'overstory mail list --to orchestrator --unread' to check for coordinator-bound messages, not '--agent coordinator'.","classification":"tactical","recorded_at":"2026-02-16T15:59:13.588Z","id":"mx-5a5a48"}
{"type":"pattern","name":"lead-single-issue-completion","description":"When dispatching a lead for multiple issues, the lead may complete only the first issue and close its session. Assign one primary issue per lead via sling, and send additional issues in the dispatch mail. If the lead closes early, spawn a new lead for remaining work.","classification":"tactical","recorded_at":"2026-02-16T15:59:15.797Z","id":"mx-d95616"}
{"type":"decision","title":"Check existing leads before spawning duplicate","rationale":"The sqlite-migration lead autonomously detected its own consumer gap and spawned queue-consumers-builder before the coordinator created a duplicate queue-fix lead. This caused overlapping work. Always check overstory status and existing lead mail before dispatching a new lead for the same file area.","classification":"tactical","recorded_at":"2026-02-16T15:59:22.856Z","id":"mx-be513c"}
{"type":"failure","description":"Task dependency sequencing issue: logs-wiring task assigned before logs.ts implementation existed, causing TypeScript and test failures. Wiring tasks should be sequenced AFTER implementation tasks.","resolution":"Agent completed wiring correctly within file scope, documented blockers in commit message and bd close reason, sent status updates to parent. For future: ensure implementation tasks complete before wiring tasks, or include stub creation in wiring scope.","classification":"tactical","recorded_at":"2026-02-16T21:15:54.867Z","id":"mx-025941"}
{"type":"convention","content":"Completion Protocol and Failure Modes must be kept in sync: when adding a new required gate to agent workflows, update both the numbered Completion Protocol steps (insert and renumber) and add a corresponding named failure mode (e.g., MISSING_MULCH_RECORD for skipping mulch record)","classification":"tactical","recorded_at":"2026-02-16T21:44:45.008Z","id":"mx-ebfa06"}
{"type":"pattern","name":"overlay-dual-paths","description":"overlay.ts formatQualityGates has dual code paths: READ_ONLY_CAPABILITIES (scout, reviewer) get lightweight completion steps with no quality gates, while writable agents (builder, lead, merger) get full test/lint/typecheck/commit gates. New completion requirements must be added to both paths.","classification":"tactical","recorded_at":"2026-02-16T21:44:53.313Z","id":"mx-48f8da"}
{"type":"failure","description":"Leads consistently exit after completing only 1 of N assigned issues. Pattern observed 3 times in phase1-hardening batch: agent-workflow-lead (1/3), observability-lead (1/3), agent-defs-lead-2 (1/2).","resolution":"Coordinator must monitor and re-dispatch replacement leads for remaining issues. Consider spawning 1 lead per issue instead of batching multiple issues to one lead for more reliable completion.","classification":"tactical","recorded_at":"2026-02-16T22:00:38.084Z","id":"mx-f9eb1b"}
{"type":"convention","content":"Read-only agents (scout, reviewer) surface reusable findings via INSIGHT: prefix in result mail body instead of running mulch record directly. Format: 'INSIGHT: <domain> <type> — <description>'. Parent agents parse and record these via mulch record. This preserves the read-only constraint while capturing valuable expertise.","classification":"tactical","recorded_at":"2026-02-17T01:32:07.354Z","id":"mx-18c15d"}
{"type":"convention","content":"Merger agents skip mulch record for clean Tier 1 merges (no conflicts). Only record learnings for non-trivial merges (Tier 2+) where conflict resolution patterns are valuable. MISSING_MULCH_RECORD failure mode is exempt for clean merges.","classification":"tactical","recorded_at":"2026-02-17T01:32:10.168Z","id":"mx-f352a4"}
{"type":"convention","content":"Parent agents (supervisor, lead) must record INSIGHT: items from read-only worker (scout, reviewer) result mails via mulch record. Read-only agents cannot write files, so they flow insights through mail to their parent.","classification":"tactical","recorded_at":"2026-02-17T01:37:26.588Z","id":"mx-fa8c93"}
{"type":"convention","content":"Parent agents (supervisor, lead) must record INSIGHT: items from read-only worker (scout, reviewer) results into mulch. For session-end auto-insights, the analyzer extracts tool usage patterns, hot files, and error patterns from EventStore data and records them as pattern/failure type mulch entries (richer than the original reference-only approach).","classification":"tactical","recorded_at":"2026-02-17T02:00:55.626Z","id":"mx-0ab1af"}
{"type":"convention","content":"All git push is blocked everywhere (agents and orchestrator) via PreToolUse hooks. Agent hooks in hooks-deployer.ts buildBashGuardScript(). Orchestrator hooks in init.ts buildHooksJson(). Users push manually outside Claude Code.","classification":"tactical","recorded_at":"2026-02-17T14:34:54.410Z","id":"mx-2a110e"}
{"type":"failure","description":"Reviewers spawned from canonical branch cannot see builder changes on builder branches. Reviewer for leadmd-builder checked canonical agents/lead.md instead of builder worktree copy, producing false FAIL.","resolution":"Reviewers need explicit instructions to check the builder worktree path or use git diff against the builder branch, not their own worktree copy.","classification":"tactical","recorded_at":"2026-02-17T15:51:19.474Z","evidence":{"bead":"overstory-9sct"},"id":"mx-0bc6ae"}
{"type":"decision","title":"Scout-first enforcement: warning not gate","rationale":"Non-blocking stderr warning in sling.ts surfaces scout-skip pattern without breaking valid edge cases. Lead.md provides documentation-level enforcement with SCOUT_SKIP failure mode, MUST language, and rebalanced cost guidance. A hard gate could block valid workflows where scout-skip exception applies.","classification":"tactical","recorded_at":"2026-02-17T15:51:25.049Z","evidence":{"bead":"overstory-9sct"},"id":"mx-e87afe"}
{"type":"convention","content":"Agent definition reinforcement pattern: when an agent consistently fails to follow instructions, strengthen language in multiple coordinated sections: (1) section title (add MANDATORY marker), (2) intro (add production failure data), (3) step language (change descriptive to imperative with MUST), (4) failure mode descriptions (add production data and structural enforcement notes), (5) completion protocol (add explicit verification step), (6) constraints (add redundant requirement). The lead.md review enforcement update demonstrates this pattern with 2/98 production data.","classification":"tactical","recorded_at":"2026-02-17T16:07:15.533Z","evidence":{"bead":"overstory-dt9o"},"id":"mx-99d99a"}
{"type":"convention","content":"Run-completion detection in watchdog daemon uses getByRun() + PERSISTENT_CAPABILITIES filter to identify worker-only sessions, then deduplicates via run-complete-notified.txt marker file before nudging coordinator.","classification":"tactical","recorded_at":"2026-02-18T15:21:21.412Z","evidence":{"bead":"overstory-b7of"},"id":"mx-6cd290"}
{"type":"convention","content":"Universal git push guard in hooks template has no ENV_GUARD prefix by design — it must block push even outside agent context. Test the env-guard test by adding a continue skip for entries where matcher=='Bash' && command includes 'git push is blocked' && \\!command includes 'OVERSTORY_AGENT_NAME'.","classification":"tactical","recorded_at":"2026-02-18T15:51:38.419Z","evidence":{"bead":"overstory-u8d0"},"id":"mx-6edad5"}
{"type":"failure","description":"watchdog-sling-lead was dispatched with 2 tasks but only completed 1 and exited without handling the second.","resolution":"Prefer 1 lead per bead issue. If combining, create sub-issues so the lead has explicit tracking for each task.","classification":"tactical","recorded_at":"2026-02-18T15:57:57.645Z","id":"mx-bd02a3"}
{"type":"failure","description":"Leads send merge_ready/worker_done to 'orchestrator' instead of 'coordinator'. Coordinator never receives via mail check --agent coordinator.","resolution":"Use overstory mail list --unread (no agent filter) to catch messages addressed to any name. File a bug to fix lead overlay to use correct coordinator address.","classification":"tactical","recorded_at":"2026-02-18T15:57:59.656Z","id":"mx-b4b61b"}
{"type":"convention","content":"PostToolUse Bash hook in hooks.json.tmpl runs mulch diff HEAD~1 silently after git commits: uses ENV_GUARD prefix, reads stdin, greps for 'git commit', redirects output to /dev/null with || true to never block. Always exits 0.","classification":"tactical","recorded_at":"2026-02-20T21:23:48.647Z","evidence":{"bead":"overstory-fnar"},"id":"mx-a56a23"}
