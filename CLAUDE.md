# Overstory

Project-agnostic swarm system for Claude Code agent orchestration. Overstory turns a single Claude Code session into a multi-agent team by spawning worker agents in git worktrees via tmux, coordinating them through a custom SQLite mail system, and merging their work back with tiered conflict resolution.

**Your Claude Code session IS the orchestrator.** There is no separate daemon. CLAUDE.md + hooks + the `overstory` CLI provide everything.

## Tech Stack

- **Runtime:** Bun (runs TypeScript directly, no build step)
- **Language:** TypeScript with strict mode (`noUncheckedIndexedAccess`, no `any`)
- **Linting:** Biome (formatter + linter in one tool)
- **Runtime dependencies:** Zero. Only Bun built-in APIs (`bun:sqlite`, `Bun.spawn`, `Bun.file`, etc.)
- **Dev dependencies:** `@types/bun`, `typescript`, `@biomejs/biome`
- **External CLIs (not npm deps):** `bd` (beads) for issue tracking, `mulch` for expertise, `git`, `tmux`

## Architecture

### Orchestrator Model

When you open Claude Code in a project with `.overstory/` initialized:
1. `SessionStart` hook runs `overstory prime` (loads config, recent activity, mulch expertise)
2. `UserPromptSubmit` hook runs `overstory mail check --inject` (surfaces new messages from agents)
3. You use the `overstory` CLI via Bash tool to spawn agents, check status, merge work

### Agent Definitions: Library Base + Dynamic Overlay

Each agent gets two instruction layers:

- **Layer 1 (Base):** Reusable `.md` files in `agents/` defining the HOW (workflow, constraints, capabilities)
- **Layer 2 (Overlay):** Per-task `CLAUDE.md` generated by `overstory sling`, written to worktree, defining the WHAT (task ID, file scope, spec path, branch name)

The orchestrator (or a team lead) only passes WHAT. The base definition already has HOW.

### Hierarchical Delegation

```
Orchestrator (your Claude Code session)
  --> Team Lead (Claude Code in tmux, can spawn sub-workers)
        --> Specialist Workers (Claude Code in tmux, leaf nodes)
```

Depth limit is configurable (default 2). Prevents runaway spawning.

### Messaging: Custom SQLite Mail

Purpose-built messaging via `bun:sqlite` in `.overstory/mail.db`. WAL mode for concurrent access from multiple agents. ~1-5ms per query. Independent of beads (which is too slow for high-frequency polling).

## Directory Structure

```
overstory/                        # This repo (the overstory tool itself)
  src/
    index.ts                      # CLI entry point (command router, 29 commands)
    types.ts                      # ALL shared types and interfaces
    config.ts                     # Config loader + defaults + validation
    errors.ts                     # Custom error types (extend OverstoryError)
    commands/                     # One file per CLI subcommand
      agents.ts                   # overstory agents (discover)
      init.ts                     # overstory init
      sling.ts                    # overstory sling (spawn worker)
      prime.ts                    # overstory prime
      status.ts                   # overstory status
      dashboard.ts                # overstory dashboard (live TUI)
      inspect.ts                  # overstory inspect (deep agent view)
      coordinator.ts              # overstory coordinator start/stop/status
      supervisor.ts               # overstory supervisor start/stop/status
      hooks.ts                    # overstory hooks install/uninstall/status
      mail.ts                     # overstory mail send/check/list/read/reply/purge
      nudge.ts                    # overstory nudge (tmux text nudge)
      merge.ts                    # overstory merge
      spec.ts                     # overstory spec write
      group.ts                    # overstory group create/status/add/remove/list
      clean.ts                    # overstory clean (nuclear cleanup)
      doctor.ts                   # overstory doctor (health checks)
      worktree.ts                 # overstory worktree list/clean
      log.ts                      # overstory log (hook target)
      logs.ts                     # overstory logs (NDJSON log query)
      feed.ts                     # overstory feed (unified event stream)
      watch.ts                    # overstory watch (watchdog)
      monitor.ts                  # overstory monitor start/stop/status (Tier 2)
      trace.ts                    # overstory trace (event timeline)
      errors.ts                   # overstory errors (aggregated error view)
      replay.ts                   # overstory replay (multi-agent replay)
      run.ts                      # overstory run list/show/complete
      costs.ts                    # overstory costs (token/cost analysis)
      metrics.ts                  # overstory metrics
      completions.ts              # overstory --completions (shell completions)
    agents/                       # Agent lifecycle management
      manifest.ts                 # Agent registry (load + query capabilities)
      overlay.ts                  # Dynamic CLAUDE.md overlay generator
      identity.ts                 # Persistent agent identity (CVs)
      hooks-deployer.ts           # Deploy hooks config to worktree
      lifecycle.ts                # Session handoff (checkpoint/resume/complete)
      checkpoint.ts               # Session checkpoint save/load/clear
    worktree/
      manager.ts                  # Create/list/cleanup git worktrees via Bun.spawn
      tmux.ts                     # Tmux session management via Bun.spawn
    sessions/
      store.ts                    # SQLite SessionStore + RunStore (agent lifecycle, runs)
      compat.ts                   # Migration bridge from sessions.json to sessions.db
    events/
      store.ts                    # SQLite EventStore (tool events, timelines, errors)
      tool-filter.ts              # Smart arg filtering for event storage
    insights/
      analyzer.ts                 # Session insight analyzer for auto-expertise
    beads/
      client.ts                   # bd CLI wrapper (--json parsing)
      molecules.ts                # Molecule management helpers
    mail/
      store.ts                    # SQLite mail storage (bun:sqlite, WAL mode)
      client.ts                   # Mail operations (send/check/list/read/reply)
      broadcast.ts                # Group address resolution (@all, @builders, etc.)
    mulch/
      client.ts                   # mulch CLI wrapper
    merge/
      queue.ts                    # FIFO merge queue
      resolver.ts                 # Tiered conflict resolution (4 tiers)
    watchdog/
      daemon.ts                   # Tier 0: mechanical process monitoring
      triage.ts                   # Tier 1: AI-assisted failure classification
      health.ts                   # Health check definitions + state machine
    logging/
      logger.ts                   # Multi-format logger (human + NDJSON)
      sanitizer.ts                # Secret redaction
      reporter.ts                 # Console reporter (ANSI colors)
      color.ts                    # Central color control (NO_COLOR, --quiet)
    metrics/
      store.ts                    # SQLite metrics storage
      summary.ts                  # Metrics reporting
      transcript.ts               # Claude Code transcript JSONL parser + cost estimation
    doctor/                       # Modular health check system
      *.ts                        # 9 check categories (see `overstory doctor --help`)
  agents/                         # Base agent definitions (the HOW)
    scout.md                      # Read-only exploration (leaf, depth 2)
    builder.md                    # Implementation (leaf, depth 2)
    reviewer.md                   # Read-only validation (leaf, depth 2)
    merger.md                     # Branch merge specialist (leaf, depth 2)
    lead.md                       # Team lead (can spawn sub-workers, depth 1)
    supervisor.md                 # Per-project supervisor (can spawn, depth 1)
    coordinator.md                # Top-level orchestrator (spawns leads only, depth 0)
    monitor.md                    # Tier 2 continuous fleet patrol (no worktree)
  templates/
    CLAUDE.md.tmpl                # Template for orchestrator CLAUDE.md
    overlay.md.tmpl               # Template for per-worker overlay
    hooks.json.tmpl               # Template for settings.local.json
  # Tests colocated: src/config.test.ts, src/mail/store.test.ts, etc.
```

### What `overstory init` creates in a target project

```
target-project/
  .overstory/
    config.yaml                   # Project configuration
    config.local.yaml             # Machine-specific overrides (gitignored)
    agent-manifest.json           # Agent registry
    hooks.json                    # Central hooks config
    current-run.txt               # Active run ID
    session-branch.txt            # Branch at session start (merge target default)
    README.md                     # Contributor-facing directory explanation
    merge-queue.db                # FIFO merge queue (SQLite, WAL mode)
    agents/{name}/                # Agent state + identity
      identity.yaml               # Persistent agent CV
      checkpoint.json             # Session checkpoint for recovery
    worktrees/{agent-name}/       # Git worktrees (gitignored)
    specs/{bead-id}.md            # Task specifications
    logs/{agent-name}/{ts}/       # Agent logs (gitignored)
    mail.db                       # SQLite mail (gitignored, WAL mode)
    sessions.db                   # SQLite sessions + runs (gitignored, WAL mode)
    events.db                     # SQLite events/timelines (gitignored, WAL mode)
    metrics.db                    # SQLite metrics (gitignored, WAL mode)
```

## Coding Conventions

### Formatting

- **Tab indentation** (enforced by Biome)
- **100 character line width** (enforced by Biome)
- Biome handles import organization automatically

### TypeScript

- Strict mode with `noUncheckedIndexedAccess` -- always handle possible `undefined` from indexing
- `noExplicitAny` is an error -- use `unknown` and narrow, or define proper types
- `useConst` is enforced -- use `const` unless reassignment is needed
- `noNonNullAssertion` is a warning -- avoid `!` postfix, check for null/undefined instead
- All shared types and interfaces go in `src/types.ts`
- All error types go in `src/errors.ts` and must extend `OverstoryError` base class

### Dependencies

- **Zero runtime dependencies.** This is a hard rule.
- Use only Bun built-in APIs: `bun:sqlite` for databases, `Bun.spawn` for subprocesses, `Bun.file` for file I/O, `Bun.write` for writes
- External tools (`bd`, `mulch`, `git`, `tmux`) are invoked as subprocesses via `Bun.spawn`, never as npm imports
- Dev dependencies are limited to types and tooling

### File Organization

- Each CLI command gets its own file in `src/commands/`
- Each subsystem gets its own directory under `src/` (agents, worktree, beads, mail, etc.)
- Base agent definitions (`.md` files) live in `agents/` at the repo root
- Templates live in `templates/` at the repo root
- Tests are colocated with source files (e.g., `src/config.test.ts`, `src/mail/store.test.ts`)

### Subprocess Execution

All external commands run through `Bun.spawn`. Capture stdout/stderr, check exit codes, throw typed errors on failure.

```typescript
const proc = Bun.spawn(["git", "worktree", "add", path, "-b", branch], {
  cwd: repoRoot,
  stdout: "pipe",
  stderr: "pipe",
});
const exitCode = await proc.exited;
if (exitCode !== 0) {
  const stderr = await new Response(proc.stderr).text();
  throw new WorktreeError(`Failed to create worktree: ${stderr}`);
}
```

### SQLite

All SQLite uses `bun:sqlite` (synchronous API). Always enable WAL mode and busy timeout for concurrent access:

```typescript
import { Database } from "bun:sqlite";
const db = new Database(dbPath);
db.exec("PRAGMA journal_mode=WAL");
db.exec("PRAGMA busy_timeout=5000");
```

## CLI Command Reference

### Core Workflow

```
overstory init                          Initialize .overstory/ in current project

overstory sling <task-id>              Spawn a worker agent
  --capability <type>                    builder | scout | reviewer | lead | merger
  --name <name>                          Unique agent name (required)
  --spec <path>                          Path to task spec file
  --files <f1,f2,...>                    Exclusive file scope (comma-separated)
  --parent <agent-name>                  Parent (for hierarchy tracking)
  --depth <n>                            Current hierarchy depth (default: 0)
  --force-hierarchy                      Bypass hierarchy validation (debugging only)
  --json                                 JSON output

overstory prime                         Load context for orchestrator/agent
  --agent <name>                         Per-agent priming
  --compact                              Less context (for PreCompact hook)

overstory spec write <bead-id>         Write a spec file to .overstory/specs/
  --body <content>                       Spec content (or pipe via stdin)
  --agent <name>                         Agent attribution
```

### Coordination Agents

```
overstory coordinator <sub>            Persistent coordinator agent
  start                                  Start coordinator (spawns Claude Code at root)
    --attach / --no-attach               Control tmux attach (default: attach on TTY)
    --watchdog                           Auto-start watchdog daemon
    --monitor                            Auto-start Tier 2 monitor agent
  stop                                   Stop coordinator (kills tmux session)
  status                                 Show coordinator state
  --json                                 JSON output

overstory supervisor <sub>             Per-project supervisor agent
  start                                  Start supervisor
    --task <bead-id>                     Bead task ID (required)
    --name <name>                        Unique name (required)
    --parent <agent>                     Parent agent (default: coordinator)
    --depth <n>                          Hierarchy depth (default: 1)
  stop --name <name>                     Stop supervisor
  status [--name <name>]                 Show supervisor(s) state
  --json                                 JSON output
```

### Messaging

```
overstory mail send                     Send a message
  --to <agent>  --subject <text>  --body <text>
  --from <name>                          Sender name
  --type <type>                          Semantic: status|question|result|error
                                         Protocol: worker_done|merge_ready|merged|
                                           merge_failed|escalation|health_check|
                                           dispatch|assign
  --priority <low|normal|high|urgent>
  --payload <json>                       Structured JSON payload
  --json                                 JSON output

overstory mail check                    Check inbox (unread messages)
  --agent <name>  --inject  --json

overstory mail list                     List messages with filters
  --from <name>  --to <name>  --unread  --json

overstory mail read <id>                Mark message as read
overstory mail reply <id> --body <text> Reply in same thread
overstory mail purge                    Delete old messages
  --all | --days <n> | --agent <name>

overstory nudge <agent> [message]       Send a text nudge to an agent via tmux
  --from <name>                          Sender name (default: orchestrator)
  --force                                Skip debounce check
  --json                                 JSON output
```

### Merge

```
overstory merge                         Merge agent branches into canonical
  --branch <name>                        Specific branch
  --all                                  All completed branches
  --into <branch>                        Target branch (default: session-branch.txt > canonicalBranch)
  --dry-run                              Check for conflicts only
  --json                                 JSON output
```

### Task Groups

```
overstory group <sub>                  Batch coordination
  create '<name>' <id1> [id2...]         Create a new task group
  status [group-id]                      Show progress for one or all groups
  add <group-id> <id1> [id2...]          Add issues to a group
  remove <group-id> <id1> [id2...]       Remove issues from a group
  list                                   List all groups (summary)
  --json  --skip-validation              JSON output / skip beads checks
```

### Observability

```
overstory status                        Show all active agents, worktrees, state
  --json  --verbose                      JSON output / extra per-agent detail
  --all                                  Show all runs (default: current run only)

overstory dashboard                     Live TUI dashboard for agent monitoring
  --interval <ms>                        Poll interval (default: 2000, min: 500)
  --all                                  Show all runs (default: current run only)

overstory inspect <agent>               Deep inspection of a single agent
  --follow                               Poll and refresh continuously
  --interval <ms>                        Polling interval (default: 3000)
  --limit <n>                            Recent tool calls to show (default: 20)
  --no-tmux                              Skip tmux capture-pane
  --json                                 JSON output

overstory trace <target>               Chronological event timeline for agent/bead
  --since <ts>  --until <ts>             Time range filter (ISO 8601)
  --limit <n>                            Max events (default: 100)
  --json                                 JSON output

overstory errors                        Aggregated error view across agents
  --agent <name>  --run <id>             Filter by agent or run
  --since <ts>  --until <ts>             Time range filter (ISO 8601)
  --limit <n>                            Max errors (default: 100)
  --json                                 JSON output

overstory replay                        Interleaved chronological replay across agents
  --run <id>  --agent <name>             Filter by run or agent (repeatable)
  --since <ts>  --until <ts>             Time range filter (ISO 8601)
  --limit <n>                            Max events (default: 200)
  --json                                 JSON output

overstory run [sub]                     Manage runs (coordinator session groupings)
  (default)                              Show current run status
  list [--last <n>]                      List recent runs (default: 10)
  show <id>                              Show run details (agents, duration)
  complete                               Mark current run as completed
  --json                                 JSON output

overstory feed [options]                Unified real-time event stream across agents
  --follow, -f                           Continuously poll for new events
  --interval <ms>                        Polling interval (default: 2000)
  --agent <name>  --run <id>             Filter by agent or run
  --since <ts>                           Start time (ISO 8601)
  --limit <n>                            Max initial events
  --json                                 JSON output

overstory logs [options]                Query NDJSON logs across agents
  --agent <name>                         Filter by agent
  --level <level>                        Filter by log level (debug|info|warn|error)
  --since <ts>  --until <ts>             Time range filter (ISO 8601 or relative)
  --limit <n>                            Max entries
  --follow                               Tail logs in real time
  --json                                 JSON output

overstory costs                          Token/cost analysis and breakdown
  --live                                 Show real-time token usage for active agents
  --self                                 Show cost for the current orchestrator session
  --agent <name>  --run <id>             Filter by agent or run
  --by-capability                        Group by capability with subtotals
  --last <n>                             Recent sessions (default: 20)
  --json                                 JSON output

overstory metrics                       Show session metrics
  --last <n>  --json
```

### Infrastructure

```
overstory hooks <sub>                  Manage orchestrator hooks
  install                                Install hooks to .claude/settings.local.json
    --force                              Overwrite existing hooks
  uninstall                              Remove hooks
  status                                 Check if hooks are installed
  --json                                 JSON output

overstory worktree list                 List worktrees with status
overstory worktree clean                Remove completed worktrees
  --completed                            Only finished agents
  --all                                  Force remove all
  --force                                Delete even if branches are unmerged

overstory log <event>                   Log a hook event (called by hooks)
  --agent <name>
  Events: tool-start, tool-end, session-end

overstory watch                         Start watchdog daemon (Tier 0)
  --interval <ms>  --background

overstory monitor <sub>                Manage Tier 2 monitor agent
  start                                  Start monitor (spawns Claude Code at root)
  stop                                   Stop monitor (kills tmux session)
  status                                 Show monitor state

overstory doctor                        Run health checks on overstory setup
  --category <name>                      Run one category only
  --verbose                              Show passing checks too
  --json                                 JSON output
  Categories: dependencies, config, structure, databases,
              consistency, agents, merge, logs, version

overstory clean                         Wipe runtime state (nuclear cleanup)
  --all                                  Wipe everything
  --mail  --sessions  --metrics          Individual DB cleanup
  --logs  --worktrees  --branches        Individual resource cleanup
  --agents  --specs                      Individual state cleanup
  --json                                 JSON output
```

## Testing

- **Framework:** `bun test` (built-in, Jest-compatible API)
- **Test location:** Tests colocated with source files (e.g., `src/config.test.ts`, `src/mail/store.test.ts`)
- **Naming:** `{module}.test.ts` matching the source file name
- **Run tests:** `bun test`
- **Run single test:** `bun test src/config.test.ts`

### Philosophy: Never mock what you can use for real

Prefer real implementations over mocks. Mocks are a last resort, not a default.

**Use real implementations for:**
- **Filesystem:** Use temp directories (`mkdtemp`) for file I/O tests
- **SQLite:** Use temp files or `:memory:` databases for `bun:sqlite` tests
- **Git:** Use real git repos in temp directories for worktree/merge tests
- **CLI tools:** Use real `bd` CLI for beads-client tests (when available)

**Only mock when the real thing has unacceptable side effects:**
- **tmux:** Real tmux operations interfere with developer sessions and are fragile in CI
- **External AI services:** API calls with real costs and latency
- **Network requests:** Flaky in CI, may incur costs

When mocking is truly necessary, document WHY in a comment at the top of the test file.

See mulch record `mx-56558b` for background on why `mock.module()` should be avoided (it leaks across test files).

### Test Helpers

Shared test utilities live in `src/test-helpers.ts`:
- `createTempGitRepo()` -- Initialize a real git repo in a temp dir with initial commit
- `cleanupTempDir()` -- Remove temp directories
- `commitFile()` -- Add and commit a file to a test repo

## Tool Integration

### beads (bd) -- Issue Tracking

```bash
bd ready                              # Find available work
bd show <id>                          # View issue details
bd update <id> --status in_progress   # Claim work
bd close <id> --reason "summary"      # Complete work
bd sync                               # Sync with git
```

Issues are tracked in `.beads/issues.jsonl`. Beads owns all task lifecycle (create, assign, close, dependencies, molecules). Overstory wraps `bd` via `src/beads/client.ts`.

### mulch -- Structured Expertise

```bash
mulch prime [domain]                  # Output priming prompt
mulch status                          # Show domain statistics
mulch record <domain>                 # Record expertise
mulch search [query]                  # Search across domains
```

Expertise records live in `.mulch/`. Overstory wraps `mulch` via `src/mulch/client.ts`.

## Quality Gates

Run all three before committing:

```bash
bun test                              # Tests pass
biome check .                         # Linting + formatting clean
tsc --noEmit                          # Type checking passes
```

Or use the package.json scripts:

```bash
bun run test                          # bun test
bun run lint                          # biome check .
bun run typecheck                     # tsc --noEmit
```

## Session Completion Protocol

When ending a work session, you MUST:

1. File issues for remaining work (`bd create`)
2. Run quality gates (if code changed): `bun test && biome check . && tsc --noEmit`
3. Update issue status: close finished work, update in-progress items
4. Push to remote (MANDATORY):
   ```bash
   git pull --rebase
   bd sync
   git push
   git status  # MUST show "up to date with origin"
   ```
5. Verify all changes are committed AND pushed
6. Hand off context for the next session

Work is NOT complete until `git push` succeeds.

<!-- mulch:start -->
## Project Expertise (Mulch)

This project uses [Mulch](https://github.com/jayminwest/mulch) for structured expertise management.

**At the start of every session**, run:
```bash
mulch prime
```

This injects project-specific conventions, patterns, decisions, and other learnings into your context.

**Before completing your task**, review your work for insights worth preserving — conventions discovered,
patterns applied, failures encountered, or decisions made — and record them:
```bash
mulch record <domain> --type <convention|pattern|failure|decision|reference|guide> --description "..."
```

Run `mulch status` to check domain health and entry counts.
Run `mulch --help` for full usage.

### Before You Finish

1. Store insights from this work session:
   ```bash
   mulch record <domain> --type <convention|pattern|failure|decision|reference|guide> --description "..."
   ```
2. Validate and commit:
   ```bash
   mulch validate && git add .mulch/ && git commit -m "mulch: record learnings"
   ```
<!-- mulch:end -->
